<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor Etiqueta</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --gray:#e5e7eb;
      --radius:14px;
      --shadow:0 10px 24px rgba(0,0,0,.06);
      --danger:#b91c1c;
      --dangerBorder:#fecaca;
      --dangerBg:#fef2f2;
      --ok:#166534;
      --okBg:#f0fdf4;
      --okBorder:#bbf7d0;

      /* Base layout (mezcla tama√±os sin desperdiciar) */
      --cols:2;
      --rows:2;
      --pagePad:6mm;
      --gap:6mm;
      --previewScale:0.58;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:var(--bg);color:var(--text)}
    h2{margin:0 0 14px;font-size:18px}

    .wrap{
      display:grid;
      grid-template-columns: minmax(320px, 520px) 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns: 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .cardHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .cardHeader h3{margin:0;font-size:14px}
    .subtle{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:12px 0}

    /* Botones */
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 12px;border:0;border-radius:12px;cursor:pointer;font-weight:900}
    .btnBlue{background:var(--blue);color:#fff}
    .btnBlue:hover{background:var(--blue2)}
    .btn2{background:var(--gray);color:var(--text)}
    .btnDanger{background:#ef4444;color:#fff}
    .btnDanger:hover{background:#dc2626}
    .btnGhost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btnSm{padding:8px 10px;border-radius:10px;font-weight:900;font-size:12px}

    /* ‚úÖ Edit m√°s visible */
    .btnEdit{
      background:#eff6ff;
      color:#1d4ed8;
      border:1px solid #bfdbfe;
    }
    .btnEdit:hover{background:#dbeafe}

    /* Form */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px 10px;
    }
    .field{min-width:0}
    .span2{grid-column:1 / -1}

    label{display:block;font-size:12px;color:#374151;margin:0 0 6px}
    input,select{
      width:100%;
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius:12px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    select:invalid{color:#9ca3af}
    option{color:#111827}

    /* UX: el nombre se ve en may√∫sculas mientras escribes */
    #fNombre{ text-transform: uppercase; }

    .fieldError{
      display:none;
      margin-top:6px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--dangerBorder);
      background:var(--dangerBg);
      color:var(--danger);
      font-size:12px;
      line-height:1.35;
    }
    .fieldError.show{display:block}
    .isInvalid{border-color:#fca5a5 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12) !important;}

    .help{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}

    /* Lista productos */
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .itemLeft{min-width:0}
    .itemTitle{margin:0;font-size:13px;font-weight:1000}
    .itemMeta{margin:4px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .itemActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .badge{
      display:inline-block;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      color:#334155;
      margin-right:6px;
      font-weight:900;
    }

    .notice{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--okBorder);
      background:var(--okBg);
      color:var(--ok);
      font-size:12px;
      line-height:1.35;
      display:none;
    }
    .notice.show{display:block}

    /* Preview */
    #paperPreviewWrap{display:flex;justify-content:center;align-items:flex-start;overflow:auto;min-height:520px}
    #paperPreview{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      padding:0;
      margin:0;
    }

    .emptyPreview{
      width:100%;
      border:1px dashed #cbd5e1;
      border-radius:16px;
      background:#fafafa;
      padding:18px;
      max-width:980px;
      text-align:center;
      color:#334155;
    }
    .emptyPreview h4{margin:0 0 6px;font-size:14px}
    .emptyPreview p{margin:0;font-size:12px;color:#64748b;line-height:1.4}

    .summaryBar{
      width:100%;
      max-width:980px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      font-weight:1000;
      color:#334155;
    }
    .summaryBar span{color:#64748b;font-weight:900}
    .summaryBar .hint{
      font-weight:900;
      color:#475569;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      white-space:nowrap;
    }

    /* Preview sin mega-espacio entre hojas */
    .page-shell{
      width: calc(215.9mm * var(--previewScale));
      height: calc(279.4mm * var(--previewScale));
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      overflow:hidden;
      position:relative;
    }
    .page-inner{
      width:215.9mm;
      height:279.4mm;
      transform: scale(var(--previewScale));
      transform-origin: top left;
    }

    .paper-page{
      width:215.9mm;
      height:279.4mm;
      padding: var(--pagePad);
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      grid-template-rows: repeat(var(--rows), 1fr);
      gap: var(--gap);
      background:#fff;
      position:relative;
    }

    .label-cell{
      display:flex;
      justify-content:center;
      align-items:center;
      overflow:hidden;
      position:relative;
      border-radius:10px;
    }
    /* Para mezclar tama√±os: siempre fill */
    .label-img{
      width:100%;
      height:100%;
      display:block;
      object-fit: contain;
    }

    /* ‚úÖ Resaltado del que est√°s agregando/editando (solo preview) */
    .hl{
      outline:4px solid #f59e0b;
      box-shadow:0 0 0 6px rgba(245,158,11,.20);
    }
    .hl::after{
      content:"EDITANDO";
      position:absolute;
      top:8px;
      left:8px;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.08em;
      color:#ffffff;
      background:rgba(7, 26, 243, 0.95);
      border:1px solid #9b00f4;
      padding:4px 8px;
      border-radius:999px;
    }

    #workCanvas{display:none}

    /* Print */
    @media print{
      body *{visibility:hidden}
      #printRoot, #printRoot *{visibility:visible}

      #printRoot{
        position:absolute;left:0;top:0;
        width:215.9mm;margin:0;padding:0;
        display:block !important;
      }

      *{-webkit-print-color-adjust:exact !important; print-color-adjust:exact !important;}

      .print-page{ page-break-after: always; break-after: page; }
      .print-page:last-child{ page-break-after: auto; break-after: auto; }

      /* ‚úÖ NO imprimir resaltados */
      .hl{ outline:none !important; box-shadow:none !important; }
      .hl::after{ display:none !important; }

      @page{ size: letter portrait; margin:0; }
    }
  </style>
</head>
<body>

  <h2>Editor de etiqueta</h2>

  <div class="wrap">

    <!-- IZQUIERDA -->
    <div class="card">
      <div class="cardHeader">
        <h3>Productos</h3>
        <span class="subtle" id="countHint">0 guardados</span>
      </div>

      <div class="btnRow" id="topActions">
        <button class="btnBlue" id="btnShowForm" type="button">+ Agregar</button>
        <button class="btnBlue" id="btnPrint" type="button" style="display:none">Imprimir</button>
        <button class="btn2" id="btnResetAll" type="button" style="display:none">Limpiar todo</button>
      </div>

      <div class="notice" id="noticeOk">‚úÖ Guardado.</div>

      <div class="divider"></div>

      <!-- Formulario -->
      <div id="formWrap" style="display:none">
        <div class="cardHeader" style="margin-bottom:10px">
          <h3 id="formTitle">Agregar producto</h3>
          <span class="subtle">Se previsualiza en vivo</span>
        </div>

        <div class="form">
          <div class="field">
            <label>Plantilla (SVG)</label>
            <select id="fTemplate" required>
              <option value="" selected disabled>Selecciona una plantilla‚Ä¶</option>
              <option value="promocion1.SVG">Promoci√≥n</option>
              <option value="normal1.SVG">Normal</option>
              <option value="liquidacion1.svg">Liquidaci√≥n</option>
              <option value="oferta1.svg">Oferta</option>
            </select>
            <div class="fieldError" id="eTemplate"></div>
          </div>

          <div class="field">
            <label>Tama√±o</label>
            <select id="fSize" required>
              <option value="" selected disabled>Selecciona un tama√±o‚Ä¶</option>
              <option value="quarter">1/4 (4 por hoja)</option>
              <option value="half_h">Media hoja horizontal (2 por hoja)</option>
              <option value="full">Carta completa (1 por hoja)</option>
            </select>
            <div class="fieldError" id="eSize"></div>
          </div>

          <div class="field span2">
            <label>Nombre</label>
            <input id="fNombre" placeholder="Ej: Laptop color rojo y verde" autocomplete="off">
            <div class="fieldError" id="eNombre"></div>
          </div>

          <div class="field">
            <label>Antes (entero, m√°x 6 d√≠gitos)</label>
            <input id="fAntes" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Ej: 3999" autocomplete="off">
            <div class="fieldError" id="eAntes"></div>
          </div>

          <div class="field">
            <label>Ahora (entero, m√°x 6 d√≠gitos)</label>
            <input id="fAhora" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Ej: 2999" autocomplete="off">
            <div class="fieldError" id="eAhora"></div>
          </div>

          <div class="field">
            <label>Cuota (entero, m√°x 6 d√≠gitos)</label>
            <input id="fCuota" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Ej: 199" autocomplete="off">
            <div class="fieldError" id="eCuota"></div>
          </div>

          <div class="field">
            <label>Cantidad</label>
            <input id="fQty" type="number" min="1" step="1" value="1">
            <div class="fieldError" id="eQty"></div>
          </div>
        </div>

        <div class="btnRow" style="margin-top:12px">
          <button class="btnBlue" id="btnSave" type="button">Guardar producto</button>
          <button class="btnGhost" id="btnCancel" type="button">Volver</button>
        </div>

        <p class="help">
          El producto que est√°s agregando/editando se marca en la previsualizaci√≥n (no se imprime).<br>
          Para que el nombre se adapte: en cada SVG crea un rect con ID <b>box_nombre_producto</b>.
        </p>

        <div class="divider"></div>
      </div>

      <!-- Lista -->
      <div id="listWrap">
        <div class="subtle">Guardados</div>
        <div class="list" id="productsList"></div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="card" id="paperPreviewWrap">
      <div id="paperPreview"></div>
    </div>

  </div>

  <div id="printRoot" style="display:none"></div>
  <canvas id="workCanvas"></canvas>

<script>
  /* =========================
     CONFIG
     ========================= */
  const IDS = {
    nombre: "nombre_producto",
    antes:  "precio_antes",
    ahora:  "precio_ahora",
    cuota:  "cuota_semanal"
  };

  // Piezas:
  // quarter = 1x1, half_h = 2x1, full = 2x2
  const PIECES = {
    quarter: { w:1, h:1, area:1, useRotated:false, label:"1/4" },
    half_h:  { w:2, h:1, area:2, useRotated:true,  label:"1/2 horizontal" },
    full:    { w:2, h:2, area:4, useRotated:false, label:"Carta completa" }
  };

  const $ = (id) => document.getElementById(id);

  /* =========================
     STATE
     ========================= */
  let products = []; // {id, template, size, nombre, antesD, ahoraD, cuotaD, qty}
  let editingId = null;

  // Draft (lo que est√°s escribiendo) para preview en vivo
  let draft = null; // {id:"__draft__", template,size,nombre,antesD,ahoraD,cuotaD,qty, __isDraft:true}

  const templateCache = new Map(); // file -> svgText
  const pngCache = new Map();      // key -> {normal, rotated}

  let renderTimer = null;
  let isRendering = false;

  /* =========================
     INPUT HELPERS
     ========================= */
  function onlyDigits(str){ return (str ?? "").toString().replace(/[^\d]/g, ""); }

  function sanitizeDigitsMax6(el){
    let cleaned = onlyDigits(el.value).slice(0, 6);
    if (cleaned.length > 1) cleaned = cleaned.replace(/^0+/, "") || "0";
    el.value = cleaned;
    return cleaned;
  }

  function formatThousands(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return "";
    return num.toLocaleString("en-US");
  }

  function toQuetzalesFromDigits(d){
    if (!d) return "";
    const n = parseInt(d, 10);
    if (!Number.isFinite(n)) return "";
    return "Q " + formatThousands(n);
  }

  function uid(){
    return "p_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function templateLabel(file){
    const map = {
      "promocion1.SVG":"Promoci√≥n",
      "normal1.SVG":"Normal",
      "liquidacion1.svg":"Liquidaci√≥n",
      "oferta1.svg":"Oferta"
    };
    return map[file] || file || "";
  }

  /* =========================
     UI: ERRORS
     ========================= */
  function setFieldError(inputId, errorId, msg){
    const input = $(inputId);
    const err = $(errorId);
    if (!input || !err) return;
    const has = !!msg;
    err.textContent = msg || "";
    err.classList.toggle("show", has);
    input.classList.toggle("isInvalid", has);
  }

  function clearAllErrors(){
    setFieldError("fTemplate","eTemplate","");
    setFieldError("fSize","eSize","");
    setFieldError("fNombre","eNombre","");
    setFieldError("fAntes","eAntes","");
    setFieldError("fAhora","eAhora","");
    setFieldError("fCuota","eCuota","");
    setFieldError("fQty","eQty","");
  }

  /* =========================
     FORM SHOW/HIDE
     ========================= */
  function setTopButtonsForMode(mode){
    if (mode === "form"){
      $("btnPrint").style.display = "none";
      $("btnResetAll").style.display = "none";
    } else {
      $("btnPrint").style.display = products.length > 0 ? "inline-block" : "none";
      $("btnResetAll").style.display = products.length > 0 ? "inline-block" : "none";
    }
  }

  function showForm(editId = null){
    $("formWrap").style.display = "block";
    $("listWrap").style.display = "none";
    $("btnShowForm").style.display = "none";
    $("noticeOk").classList.remove("show");

    setTopButtonsForMode("form");

    editingId = editId;

    if (!editId){
      $("formTitle").textContent = "Agregar producto";
      $("btnSave").textContent = "Guardar producto";
      clearAllErrors();

      $("fTemplate").value = "";
      $("fSize").value = "";
      $("fNombre").value = "";
      $("fAntes").value = "";
      $("fAhora").value = "";
      $("fCuota").value = "";
      $("fQty").value = "1";

      // crea draft vac√≠o y resalta en preview cuando ya haya template/size
      draft = {
        id: "__draft__",
        template: "",
        size: "",
        nombre: "",
        antesD: "",
        ahoraD: "",
        cuotaD: "",
        qty: 1,
        __isDraft: true
      };
      scheduleRebuildAll(true);
      return;
    }

    const p = products.find(x => x.id === editId);
    if (!p) return;

    $("formTitle").textContent = "Editar producto";
    $("btnSave").textContent = "Guardar cambios";
    clearAllErrors();

    $("fTemplate").value = p.template;
    $("fSize").value = p.size;
    $("fNombre").value = p.nombre;
    $("fAntes").value = p.antesD;
    $("fAhora").value = p.ahoraD;
    $("fCuota").value = p.cuotaD;
    $("fQty").value = String(p.qty);

    // draft clonado del producto editado (para marcar y ver el acomodo)
    draft = { ...p, __isDraft: true };
    scheduleRebuildAll(true);
  }

  function hideForm(){
    $("formWrap").style.display = "none";
    $("listWrap").style.display = "block";
    $("btnShowForm").style.display = "inline-block";
    editingId = null;

    // al salir del form: ya no hay draft en preview
    draft = null;

    clearAllErrors();
    setTopButtonsForMode("list");
    scheduleRebuildAll(true);
  }

  /* =========================
     VALIDATION (SAVE)
     ========================= */
  function validateFormForSave(){
    clearAllErrors();

    const template = $("fTemplate").value;
    const size = $("fSize").value;

    const nombre = ($("fNombre").value || "").trim();
    const antesD = sanitizeDigitsMax6($("fAntes"));
    const ahoraD = sanitizeDigitsMax6($("fAhora"));
    const cuotaD = sanitizeDigitsMax6($("fCuota"));

    const qtyRaw = parseInt($("fQty").value, 10);
    const qty = Number.isFinite(qtyRaw) && qtyRaw > 0 ? qtyRaw : 0;

    let ok = true;

    if (!template){ setFieldError("fTemplate","eTemplate","Selecciona una plantilla."); ok = false; }
    if (!size){ setFieldError("fSize","eSize","Selecciona un tama√±o."); ok = false; }

    if (!nombre){ setFieldError("fNombre","eNombre","Este campo es obligatorio."); ok = false; }
    if (!antesD){ setFieldError("fAntes","eAntes","Ingresa 'Antes' (m√°x 6 d√≠gitos)."); ok = false; }
    if (!ahoraD){ setFieldError("fAhora","eAhora","Ingresa 'Ahora' (m√°x 6 d√≠gitos)."); ok = false; }
    if (!cuotaD){ setFieldError("fCuota","eCuota","Ingresa 'Cuota' (m√°x 6 d√≠gitos)."); ok = false; }
    if (!qty){ setFieldError("fQty","eQty","Cantidad debe ser mayor a 0."); ok = false; }

    if (antesD && ahoraD){
      const antesN = parseInt(antesD, 10);
      const ahoraN = parseInt(ahoraD, 10);
      if (Number.isFinite(antesN) && Number.isFinite(ahoraN) && ahoraN > antesN){
        setFieldError("fAhora","eAhora","'Ahora' no puede ser mayor que 'Antes'.");
        ok = false;
      }
    }

    if (!ok) return { ok:false };

    return {
      ok:true,
      data: { template, size, nombre, antesD, ahoraD, cuotaD, qty }
    };
  }

  /* =========================
     DRAFT LIVE UPDATE
     ========================= */
  function syncDraftFromForm(){
    if (!draft) return;

    draft.template = $("fTemplate").value || "";
    draft.size = $("fSize").value || "";
    draft.nombre = ($("fNombre").value || "").trim();
    draft.antesD = onlyDigits($("fAntes").value || "").slice(0,6);
    draft.ahoraD = onlyDigits($("fAhora").value || "").slice(0,6);
    draft.cuotaD = onlyDigits($("fCuota").value || "").slice(0,6);

    const qtyRaw = parseInt($("fQty").value, 10);
    draft.qty = Number.isFinite(qtyRaw) && qtyRaw > 0 ? qtyRaw : 1;

    // si est√° editando un producto guardado, el highlight ser√° ese ID
    // si est√° agregando, se resalta "__draft__"
  }

  /* =========================
     LIST UI
     ========================= */
  function updateTopUI(){
    $("countHint").textContent = `${products.length} guardados`;
    if (!editingId && $("formWrap").style.display === "none"){
      $("btnPrint").style.display = products.length > 0 ? "inline-block" : "none";
      $("btnResetAll").style.display = products.length > 0 ? "inline-block" : "none";
    }
  }

  function renderProductsList(){
    const wrap = $("productsList");
    wrap.innerHTML = "";

    if (products.length === 0){
      wrap.innerHTML = `
        <div class="emptyPreview" style="max-width:none">
          <h4>Sin productos guardados</h4>
          <p>Haz clic en <b>Agregar producto</b> para empezar.</p>
        </div>
      `;
      return;
    }

    products.forEach(p => {
      const before = toQuetzalesFromDigits(p.antesD);
      const now = toQuetzalesFromDigits(p.ahoraD);
      const cuota = toQuetzalesFromDigits(p.cuotaD);
      const piece = PIECES[p.size];

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemLeft">
          <p class="itemTitle">${escapeHtml(p.nombre).toUpperCase()}</p>
          <p class="itemMeta">
            <span class="badge">${escapeHtml(templateLabel(p.template))}</span>
            <span class="badge">${escapeHtml(piece?.label || p.size)}</span>
            <span class="badge">Qty: ${p.qty}</span><br/>
            Antes: <b>${escapeHtml(before)}</b> ¬∑ Ahora: <b>${escapeHtml(now)}</b> ¬∑ Cuota: <b>${escapeHtml(cuota)}</b>
          </p>
        </div>
        <div class="itemActions">
          <button class="btnEdit btnSm" type="button" data-act="edit" data-id="${p.id}">‚úèÔ∏è Editar</button>
          <button class="btnDanger btnSm" type="button" data-act="del" data-id="${p.id}">üóëÔ∏è Eliminar</button>
        </div>
      `;
      wrap.appendChild(el);
    });

    wrap.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if (act === "edit") showForm(id);
        if (act === "del") deleteProduct(id);
      });
    });
  }

  function deleteProduct(id){
    const p = products.find(x => x.id === id);
    if (!p) return;

    const ok = confirm(`¬øEliminar este producto?\n\n${p.nombre.toUpperCase()}\nCantidad: ${p.qty}`);
    if (!ok) return;

    products = products.filter(x => x.id !== id);

    updateTopUI();
    renderProductsList();
    scheduleRebuildAll(true);
  }

  /* =========================
     SVG / PNG
     ========================= */
  function getSvgViewBox(svg) {
    const vb = svg.viewBox && svg.viewBox.baseVal;
    if (vb && vb.width && vb.height) return { x: vb.x, y: vb.y, w: vb.width, h: vb.height };
    const w = parseFloat(svg.getAttribute("width") || "0") || 0;
    const h = parseFloat(svg.getAttribute("height") || "0") || 0;
    return { x: 0, y: 0, w: w || 1000, h: h || 1000 };
  }

  function getTextBoxById(svg, textId) {
    const box = svg.querySelector(`#box_${CSS.escape(textId)}`);
    if (box && typeof box.getBBox === "function") {
      const b = box.getBBox();
      return { x: b.x, y: b.y, w: b.width, h: b.height, cx: b.x + b.width/2, cy: b.y + b.height/2 };
    }
    const vb = getSvgViewBox(svg);
    const w = vb.w * 0.85;
    const h = vb.h * 0.18;
    return { x: vb.x + (vb.w - w)/2, y: vb.y + vb.h*0.18, w, h, cx: vb.x + vb.w/2, cy: vb.y + vb.h*0.27 };
  }

  function getFontSizePx(textEl) {
    const fsAttr = textEl.getAttribute("font-size");
    if (fsAttr) {
      const n = parseFloat(fsAttr);
      if (Number.isFinite(n)) return n;
    }
    const cs = window.getComputedStyle(textEl);
    const n = parseFloat(cs.fontSize || "0");
    return Number.isFinite(n) && n > 0 ? n : 16;
  }

  function clearSvgText(textEl){
    if (!textEl) return;
    while (textEl.firstChild) textEl.removeChild(textEl.firstChild);
    textEl.textContent = "";
  }

  function setWrappedTextInBox(textEl, text, box, opts = {}) {
    const NS = "http://www.w3.org/2000/svg";
    const t = (text || "").trim();
    if (!t) { clearSvgText(textEl); return; }

    const words = t.split(/\s+/).filter(Boolean);
    const lineHeightEm = opts.lineHeightEm ?? 1.10;
    const maxWidth = box.w;

    const fontPx = getFontSizePx(textEl);
    const maxLines = Math.max(1, Math.floor(box.h / (fontPx * lineHeightEm)));

    const cx = box.cx;
    const cy = box.cy;

    textEl.setAttribute("text-anchor", "middle");
    textEl.setAttribute("x", cx);
    textEl.setAttribute("y", cy);

    while (textEl.firstChild) textEl.removeChild(textEl.firstChild);

    const meas = document.createElementNS(NS, "tspan");
    meas.setAttribute("x", cx);
    textEl.appendChild(meas);

    let lines = [];
    let line = [];

    for (let i = 0; i < words.length; i++) {
      line.push(words[i]);
      meas.textContent = line.join(" ");
      if (meas.getComputedTextLength() > maxWidth && line.length > 1) {
        line.pop();
        lines.push(line.join(" "));
        line = [words[i]];
        if (lines.length === maxLines) break;
        meas.textContent = line.join(" ");
      }
    }
    if (lines.length < maxLines && line.length) lines.push(line.join(" "));

    if (words.length && lines.length === maxLines) {
      let last = lines[lines.length - 1];
      meas.textContent = last;
      while (meas.getComputedTextLength() > maxWidth && last.length > 1) {
        last = last.slice(0, -2) + "‚Ä¶";
        meas.textContent = last;
      }
      lines[lines.length - 1] = last;
    }

    while (textEl.firstChild) textEl.removeChild(textEl.firstChild);

    const n = Math.max(lines.length, 1);
    const totalEm = (n - 1) * lineHeightEm;
    const firstDy = -totalEm / 2;

    lines.forEach((txt, idx) => {
      const ts = document.createElementNS(NS, "tspan");
      ts.setAttribute("x", cx);
      ts.setAttribute("dy", (idx === 0 ? firstDy : lineHeightEm) + "em");
      ts.textContent = txt;
      textEl.appendChild(ts);
    });
  }

  function setTextSmartCentered(textEl, value){
    if (!textEl) return;
    const txt = (value ?? "").toString().trim();
    if (!txt) { clearSvgText(textEl); return; }
    textEl.setAttribute("text-anchor", "middle");
    const tspan = textEl.querySelector("tspan");
    if (tspan) tspan.textContent = txt;
    else textEl.textContent = txt;
  }

  async function getTemplateText(file){
    if (templateCache.has(file)) return templateCache.get(file);
    const res = await fetch(file, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo cargar " + file);
    const txt = await res.text();
    templateCache.set(file, txt);
    return txt;
  }

  function mountHiddenSvg(svgText){
    const old = $("__svgHostHidden");
    if (old) old.remove();

    const host = document.createElement("div");
    host.id = "__svgHostHidden";
    host.style.position = "absolute";
    host.style.left = "-99999px";
    host.style.top = "-99999px";
    host.innerHTML = svgText;
    document.body.appendChild(host);

    const svgEl = host.querySelector("svg");
    return { host, svgEl };
  }

  async function svgNodeToPng(svgNode, targetWidthPx = 2200){
    const serializer = new XMLSerializer();
    let svgText = serializer.serializeToString(svgNode);

    if (!svgText.includes('xmlns="http://www.w3.org/2000/svg"')) {
      svgText = svgText.replace("<svg", '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if (!svgText.includes('xmlns:xlink="http://www.w3.org/1999/xlink"')) {
      svgText = svgText.replace("<svg", '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    const vb = getSvgViewBox(svgNode);
    const w = vb.w || parseFloat(svgNode.getAttribute("width") || "408");
    const h = vb.h || parseFloat(svgNode.getAttribute("height") || "528");

    const scale = targetWidthPx / w;
    const cw = Math.round(w * scale);
    const ch = Math.round(h * scale);

    const blob = new Blob([svgText], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.crossOrigin = "anonymous";

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = url;
    });

    const canvas = $("workCanvas");
    canvas.width = cw;
    canvas.height = ch;

    const ctx = canvas.getContext("2d");
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, cw, ch);
    ctx.drawImage(img, 0, 0, cw, ch);

    URL.revokeObjectURL(url);
    return canvas.toDataURL("image/png");
  }

  async function rotatePng90(pngDataUrl){
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = pngDataUrl;
    });

    const canvas = $("workCanvas");
    canvas.width = img.height;
    canvas.height = img.width;

    const ctx = canvas.getContext("2d");
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.translate(canvas.width, 0);
    ctx.rotate(Math.PI / 2);
    ctx.drawImage(img, 0, 0);

    return canvas.toDataURL("image/png");
  }

  async function renderProductPngs(product){
    // ‚úÖ si no hay template, no se puede renderizar
    if (!product.template) return null;

    const key = JSON.stringify({
      t: product.template,
      n: (product.nombre||"").trim().toUpperCase(),
      a: product.antesD,
      b: product.ahoraD,
      c: product.cuotaD
    });

    if (pngCache.has(key)) return pngCache.get(key);

    const svgText = await getTemplateText(product.template);
    const { host, svgEl } = mountHiddenSvg(svgText);

    const nombre = (product.nombre || "").trim().toUpperCase();
    const antes = toQuetzalesFromDigits(product.antesD);
    const ahora = toQuetzalesFromDigits(product.ahoraD);
    const cuota = toQuetzalesFromDigits(product.cuotaD);

    const nameEl = host.querySelector(`#${CSS.escape(IDS.nombre)}`);
    if (nameEl && svgEl){
      const box = getTextBoxById(svgEl, IDS.nombre);
      setWrappedTextInBox(nameEl, nombre, box, { lineHeightEm: 1.10 });
    }

    setTextSmartCentered(host.querySelector(`#${CSS.escape(IDS.antes)}`), antes);
    setTextSmartCentered(host.querySelector(`#${CSS.escape(IDS.ahora)}`), ahora);
    setTextSmartCentered(host.querySelector(`#${CSS.escape(IDS.cuota)}`), cuota);

    const normal = await svgNodeToPng(svgEl, 2200);
    const rotated = await rotatePng90(normal);

    host.remove();

    const out = { normal, rotated };
    pngCache.set(key, out);
    return out;
  }

  /* =========================
     PACKING (incremental: rellena huecos primero)
     ========================= */
  function buildWorkingSet(){
    // ‚úÖ incluye draft si existe y tiene size/template seleccionados (para ver acomodo real)
    const out = [...products];

    if (draft && draft.size && draft.template){
      if (editingId){
        // si estoy editando, reemplazo temporalmente el producto por el draft
        const idx = out.findIndex(x => x.id === editingId);
        if (idx >= 0) out[idx] = { ...draft };
        else out.unshift({ ...draft });
      } else {
        // si estoy agregando, lo a√±ado al final (o al inicio) para verlo entrando a huecos
        out.push({ ...draft });
      }
    }

    return out;
  }

  function buildInstances(workingProducts){
    const out = [];
    let seq = 0;

    for (const p of workingProducts){
      const piece = PIECES[p.size];
      if (!piece) continue;
      const qty = Number(p.qty || 0);
      if (!Number.isFinite(qty) || qty <= 0) continue;

      for (let i=0;i<qty;i++){
        out.push({
          seq: seq++,
          product: p,
          pieceKey: p.size,
          piece,
          __isDraft: !!p.__isDraft
        });
      }
    }

    // ‚úÖ Para minimizar hojas (y llenar huecos): grandes primero
    // Si empate: los que ya est√°n guardados primero, luego draft (para que el draft ‚Äúentre‚Äù en huecos disponibles)
    out.sort((a,b)=>{
      if (b.piece.area !== a.piece.area) return b.piece.area - a.piece.area;
      if (a.__isDraft !== b.__isDraft) return a.__isDraft ? 1 : -1;
      return a.seq - b.seq;
    });

    return out;
  }

  function emptyOcc(){
    return [[false,false],[false,false]];
  }

  function canPlace(occ, row, col, w, h){
    if (row + h > 2 || col + w > 2) return false;
    for (let r=row; r<row+h; r++){
      for (let c=col; c<col+w; c++){
        if (occ[r][c]) return false;
      }
    }
    return true;
  }

  function place(occ, row, col, w, h){
    for (let r=row; r<row+h; r++){
      for (let c=col; c<col+w; c++){
        occ[r][c] = true;
      }
    }
  }

  function firstFitInPage(page, inst){
    const { w, h } = inst.piece;

    if (w === 2 && h === 2){
      if (canPlace(page.occ, 0, 0, 2, 2)){
        place(page.occ, 0, 0, 2, 2);
        page.items.push({ inst, row:0, col:0, w:2, h:2 });
        return true;
      }
      return false;
    }

    if (w === 2 && h === 1){
      for (let row=0; row<2; row++){
        if (canPlace(page.occ, row, 0, 2, 1)){
          place(page.occ, row, 0, 2, 1);
          page.items.push({ inst, row, col:0, w:2, h:1 });
          return true;
        }
      }
      return false;
    }

    for (let row=0; row<2; row++){
      for (let col=0; col<2; col++){
        if (canPlace(page.occ, row, col, 1, 1)){
          place(page.occ, row, col, 1, 1);
          page.items.push({ inst, row, col, w:1, h:1 });
          return true;
        }
      }
    }
    return false;
  }

  function packToPages(instances){
    const pages = [];
    for (const inst of instances){
      let placed = false;

      // ‚úÖ rellena huecos en p√°ginas existentes primero
      for (const page of pages){
        if (firstFitInPage(page, inst)){
          placed = true;
          break;
        }
      }

      // si no cabe, crea nueva hoja
      if (!placed){
        const page = { occ: emptyOcc(), items: [] };
        if (firstFitInPage(page, inst)){
          pages.push(page);
        }
      }
    }
    return pages;
  }

  /* =========================
     PREVIEW
     ========================= */
  function showEmptyPreview(title, body){
    $("paperPreview").innerHTML = `
      <div class="emptyPreview">
        <h4>${title}</h4>
        <p>${body}</p>
      </div>
    `;
  }

  function buildPageDOM(pageItems, prodToPng, highlightId){
    const shell = document.createElement("div");
    shell.className = "page-shell";

    const inner = document.createElement("div");
    inner.className = "page-inner";

    const page = document.createElement("div");
    page.className = "paper-page";

    for (const it of pageItems){
      const { inst, row, col, w, h } = it;
      const cell = document.createElement("div");
      cell.className = "label-cell";
      cell.style.gridRow = `${row+1} / span ${h}`;
      cell.style.gridColumn = `${col+1} / span ${w}`;

      const pid = inst.product.id;
      const isHighlight = highlightId && (pid === highlightId || (inst.__isDraft && highlightId === "__draft__"));
      if (isHighlight) cell.classList.add("hl");

      const pngs = prodToPng.get(pid);
      if (!pngs){
        // si no hay png (ej: draft sin template) no pintamos nada
        continue;
      }

      const img = document.createElement("img");
      img.className = "label-img";
      img.alt = "Etiqueta";
      img.src = inst.piece.useRotated ? pngs.rotated : pngs.normal;

      cell.appendChild(img);
      page.appendChild(cell);
    }

    inner.appendChild(page);
    shell.appendChild(inner);
    return shell;
  }

  async function buildAllPreview(){
    const working = buildWorkingSet();

    if (working.length === 0){
      showEmptyPreview("Sin previsualizaci√≥n", "Agrega al menos un producto para ver las hojas aqu√≠.");
      return;
    }

    const instances = buildInstances(working);
    if (instances.length === 0){
      showEmptyPreview("Completa plantilla y tama√±o", "Selecciona plantilla y tama√±o para ver el acomodo en la hoja.");
      return;
    }

    if (isRendering) return;
    isRendering = true;

    try{
      // 1) PNGs por producto (incluye draft si aplica)
      const prodToPng = new Map();
      for (const p of working){
        const pngs = await renderProductPngs(p);
        if (pngs) prodToPng.set(p.id, pngs);
      }

      // 2) packing
      const pages = packToPages(instances);

      const preview = $("paperPreview");
      preview.innerHTML = "";

      // highlight id: si editando => editingId, si agregando => "__draft__"
      const highlightId = draft ? (editingId ? editingId : "__draft__") : null;

      const sum = document.createElement("div");
      sum.className = "summaryBar";
      sum.innerHTML = `
        <div>Total etiquetas: ${instances.length}</div>
        <span>Hojas: ${pages.length}</span>
        ${draft ? `<div class="hint">Marcado: ${editingId ? "EDITANDO" : "AGREGANDO"}</div>` : `<div class="hint">Vista general</div>`}
      `;
      preview.appendChild(sum);

      for (const page of pages){
        preview.appendChild(buildPageDOM(page.items, prodToPng, highlightId));
      }

    }catch(e){
      console.error(e);
      showEmptyPreview("Error en previsualizaci√≥n", "No se pudo generar. Verifica que los SVG existan junto al HTML.");
    }finally{
      isRendering = false;
    }
  }

  function scheduleRebuildAll(force=false){
    if (renderTimer) clearTimeout(renderTimer);
    renderTimer = setTimeout(buildAllPreview, force ? 0 : 120);
  }

  /* =========================
     PRINT (sin draft / sin highlights)
     ========================= */
  function buildPrintPageDOM(pageItems, prodToPng){
    const wrap = document.createElement("div");
    wrap.className = "print-page";

    const page = document.createElement("div");
    page.className = "paper-page";

    for (const it of pageItems){
      const { inst, row, col, w, h } = it;
      if (inst.__isDraft) continue; // ‚úÖ NUNCA imprimir draft

      const cell = document.createElement("div");
      cell.className = "label-cell";
      cell.style.gridRow = `${row+1} / span ${h}`;
      cell.style.gridColumn = `${col+1} / span ${w}`;

      const pngs = prodToPng.get(inst.product.id);
      if (!pngs) continue;

      const img = document.createElement("img");
      img.className = "label-img";
      img.alt = "Etiqueta";
      img.src = inst.piece.useRotated ? pngs.rotated : pngs.normal;

      cell.appendChild(img);
      page.appendChild(cell);
    }

    wrap.appendChild(page);
    return wrap;
  }

  async function printNow(){
    if (products.length === 0) return;

    try{
      const prodToPng = new Map();
      for (const p of products){
        const pngs = await renderProductPngs(p);
        if (pngs) prodToPng.set(p.id, pngs);
      }

      const instances = buildInstances(products);
      const pages = packToPages(instances);

      const printRoot = $("printRoot");
      printRoot.innerHTML = "";
      printRoot.style.display = "block";

      for (const page of pages){
        printRoot.appendChild(buildPrintPageDOM(page.items, prodToPng));
      }

      const cleanup = () => {
        printRoot.style.display = "none";
        printRoot.innerHTML = "";
        window.removeEventListener("afterprint", cleanup);
        scheduleRebuildAll(true);
      };
      window.addEventListener("afterprint", cleanup);

      window.print();

    }catch(e){
      console.error(e);
      $("printRoot").style.display = "none";
      $("printRoot").innerHTML = "";
      alert("No se pudo imprimir. Verifica que los SVG existan y que el navegador permita imprimir.");
      scheduleRebuildAll(true);
    }
  }

  /* =========================
     SAVE / EDIT / CLEAR
     ========================= */
  function saveProduct(){
    const v = validateFormForSave();
    if (!v.ok) return;

    const data = v.data;

    if (!editingId){
      products.unshift({ id: uid(), ...data });
    } else {
      const idx = products.findIndex(x => x.id === editingId);
      if (idx >= 0) products[idx] = { ...products[idx], ...data };
    }

    $("noticeOk").classList.add("show");
    setTimeout(()=> $("noticeOk").classList.remove("show"), 1200);

    // al guardar: se elimina draft y vuelve a lista
    draft = null;
    hideForm();

    updateTopUI();
    renderProductsList();
    scheduleRebuildAll(true);
  }

  function clearAll(){
    const ok = confirm("¬øEliminar todos los productos guardados?");
    if (!ok) return;
    products = [];
    draft = null;
    updateTopUI();
    renderProductsList();
    scheduleRebuildAll(true);
  }

  /* =========================
     LIST UI
     ========================= */
  function updateTopUI(){
    $("countHint").textContent = `${products.length} guardados`;
    if (!editingId && $("formWrap").style.display === "none"){
      $("btnPrint").style.display = products.length > 0 ? "inline-block" : "none";
      $("btnResetAll").style.display = products.length > 0 ? "inline-block" : "none";
    }
  }

  function renderProductsList(){
    const wrap = $("productsList");
    wrap.innerHTML = "";

    if (products.length === 0){
      wrap.innerHTML = `
        <div class="emptyPreview" style="max-width:none">
          <h4>Sin productos guardados</h4>
          <p>Haz clic en <b>Agregar producto</b> para empezar.</p>
        </div>
      `;
      return;
    }

    products.forEach(p => {
      const before = toQuetzalesFromDigits(p.antesD);
      const now = toQuetzalesFromDigits(p.ahoraD);
      const cuota = toQuetzalesFromDigits(p.cuotaD);
      const piece = PIECES[p.size];

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemLeft">
          <p class="itemTitle">${escapeHtml(p.nombre).toUpperCase()}</p>
          <p class="itemMeta">
            <span class="badge">${escapeHtml(templateLabel(p.template))}</span>
            <span class="badge">${escapeHtml(piece?.label || p.size)}</span>
            <span class="badge">Qty: ${p.qty}</span><br/>
            Antes: <b>${escapeHtml(before)}</b> ¬∑ Ahora: <b>${escapeHtml(now)}</b> ¬∑ Cuota: <b>${escapeHtml(cuota)}</b>
          </p>
        </div>
        <div class="itemActions">
          <button class="btnEdit btnSm" type="button" data-act="edit" data-id="${p.id}">‚úèÔ∏è Editar</button>
          <button class="btnDanger btnSm" type="button" data-act="del" data-id="${p.id}">üóëÔ∏è Eliminar</button>
        </div>
      `;
      wrap.appendChild(el);
    });

    wrap.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if (act === "edit") showForm(id);
        if (act === "del") deleteProduct(id);
      });
    });
  }

  function deleteProduct(id){
    const p = products.find(x => x.id === id);
    if (!p) return;

    const ok = confirm(`¬øEliminar este producto?\n\n${p.nombre.toUpperCase()}\nCantidad: ${p.qty}`);
    if (!ok) return;

    products = products.filter(x => x.id !== id);

    updateTopUI();
    renderProductsList();
    scheduleRebuildAll(true);
  }

  /* =========================
     EVENTS
     ========================= */
  $("btnShowForm").addEventListener("click", ()=> showForm(null));
  $("btnCancel").addEventListener("click", hideForm);
  $("btnSave").addEventListener("click", saveProduct);
  $("btnPrint").addEventListener("click", printNow);
  $("btnResetAll").addEventListener("click", clearAll);

  // inputs: live draft + preview
  function onFormChange(){
    // sanitiza
    sanitizeDigitsMax6($("fAntes"));
    sanitizeDigitsMax6($("fAhora"));
    sanitizeDigitsMax6($("fCuota"));

    // draft
    if (draft){
      syncDraftFromForm();
      scheduleRebuildAll();
    }
  }

  ["fTemplate","fSize","fNombre","fQty"].forEach(id=>{
    $(id).addEventListener("input", onFormChange);
    $(id).addEventListener("change", onFormChange);
  });

  ["fAntes","fAhora","fCuota"].forEach(id=>{
    const el = $(id);

    el.addEventListener("keydown", (e)=>{
      const allowed = ["Backspace","Delete","ArrowLeft","ArrowRight","Home","End","Tab"];
      if (allowed.includes(e.key)) return;
      if (e.ctrlKey || e.metaKey) return;
      if (!/^\d$/.test(e.key)) e.preventDefault();
    });

    el.addEventListener("input", onFormChange);
    el.addEventListener("paste", ()=> setTimeout(onFormChange, 0));
  });

  /* =========================
     INIT
     ========================= */
  (function init(){
    updateTopUI();
    renderProductsList();
    setTopButtonsForMode("list");
    showEmptyPreview("Sin previsualizaci√≥n", "Agrega al menos un producto para ver las hojas aqu√≠.");
  })();
</script>
</body>
</html>
