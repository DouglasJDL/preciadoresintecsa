<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor Etiqueta</title>

  <!-- ‚úÖ Exportar a PDF (jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ‚úÖ Importar/Exportar Excel (SheetJS/xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 10px 24px rgba(0,0,0,.06);

      --danger:#b91c1c;
      --dangerBorder:#fecaca;
      --dangerBg:#fef2f2;

      --padGrid: 6mm;
      --gapGrid: 6mm;
      --padFull: 10mm;

      --focus: rgba(59,130,246,.18);
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      font-family:system-ui,Segoe UI,Roboto,Arial;
      margin:20px;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    h2{margin:0 0 14px;font-size:18px}

    .wrap{
      display:grid;
      grid-template-columns: minmax(320px, 460px) 1fr;
      gap:16px;
      align-items:stretch;
      height: calc(100vh - 20px - 20px - 32px);
      min-height: 520px;
    }
    @media (max-width: 980px){
      body{overflow:auto;height:auto;}
      .wrap{grid-template-columns:1fr;height:auto;min-height:auto;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    /* ‚úÖ panel izquierdo */
    #leftCard{display:flex;flex-direction:column;height:100%;min-height:0}
    #listView, #formView{display:flex;flex-direction:column;flex:1;min-height:0}
    .leftScrollArea{flex:1;min-height:0;overflow:auto;padding-right:4px}

    /* ‚úÖ panel derecho (preview) */
    #paperPreviewWrap{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:auto;
      height:100%;
      min-height:0;
      background:transparent;
    }

    .cardHeader{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:12px
    }
    .cardHeader h3{margin:0;font-size:14px}
    .subtle{font-size:12px;color:var(--muted)}

    /* ===== Botones ===== */
    button{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:1000;
      border:1px solid transparent;
      transition: background .15s ease, border-color .15s ease, transform .05s ease, box-shadow .15s ease, opacity .15s ease;
      user-select:none;
      background:#fff;
    }
    button:active{ transform: translateY(1px); }
    button:focus-visible{ outline:none; box-shadow:0 0 0 4px var(--focus); }
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btnPrimary{ background:#2563eb; color:#fff; }
    .btnPrimary:hover{ background:#1d4ed8; }

    .btnSuccess{ background:#16a34a; color:#fff; }
    .btnSuccess:hover{ background:#15803d; }

    .btnNeutral{ background:#eef2f7; color:#0f172a; border-color:#dbe3ee; }
    .btnNeutral:hover{ background:#e5e7eb; }

    /* ‚úÖ Icon buttons */
    .btnIcon{
      width:40px;height:40px;padding:0;border-radius:12px;
      background:#ffffff;border:1px solid #e5e7eb;color:#0f172a;
    }
    .btnIcon:hover{background:#f8fafc;border-color:#dbe3ee}
    .btnIcon:focus-visible{ box-shadow:0 0 0 4px rgba(148,163,184,.22); }
    .btnIcon.danger{ color:#b91c1c; background:#fff; border-color:#fee2e2; }
    .btnIcon.danger:hover{ background:#fef2f2; border-color:#fecaca; }
    .btnIcon.warning{ color:#92400e; background:#fff; border-color:#fde68a; }
    .btnIcon.warning:hover{ background:#fffbeb; border-color:#fcd34d; }
    .btnIcon.success{ color:#166534; background:#fff; border-color:#bbf7d0; }
    .btnIcon.success:hover{ background:#f0fdf4; border-color:#86efac; }
    .btnIcon.primary{ color:#1d4ed8; background:#fff; border-color:#bfdbfe; }
    .btnIcon.primary:hover{ background:#eff6ff; border-color:#93c5fd; }

    .btnIcon svg{width:18px;height:18px;display:block}

    /* ‚úÖ spinner */
    .spin{
      width:18px;height:18px;border-radius:999px;
      border:2px solid currentColor;border-top-color:transparent;
      animation:spin .8s linear infinite;
      display:block;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ===== Form ===== */
    .form{display:grid;grid-template-columns: 1fr 1fr;gap:12px 10px;}
    .field{min-width:0}
    .span2{grid-column:1 / -1}
    label{display:block;font-size:12px;color:#374151;margin:0 0 6px}

    input,select{
      width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;
      font-size:14px;background:#fff;outline:none;
    }
    input:focus,select:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    select:invalid{color:#9ca3af}
    option{color:#111827}
    #fNombre{ text-transform: uppercase; }

    .fieldError{
      display:none;margin-top:6px;padding:8px 10px;border-radius:12px;
      border:1px solid var(--dangerBorder);background:var(--dangerBg);color:var(--danger);
      font-size:12px;line-height:1.35;
    }
    .fieldError.show{display:block}
    .isInvalid{border-color:#fca5a5 !important; box-shadow:0 0 0 3px rgba(239,68,68,.12) !important;}

    .help{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}

    .toggleRow{
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      border:1px solid #e5e7eb;border-radius:12px;background:#fafafa;
    }
    .toggleRow input{width:auto;padding:0;margin:0}
    .toggleRow span{font-size:13px;color:#0f172a;font-weight:1000}
    .toggleRow small{display:block;font-size:12px;color:#64748b;font-weight:600}

    /* ===== Lista ===== */
    .listEmpty{
      border:1px dashed #cbd5e1;border-radius:14px;background:#fafafa;padding:14px;
      color:#334155;font-size:13px;line-height:1.4;
    }
    .items{display:flex;flex-direction:column;gap:10px;overflow:auto;padding-right:2px}

    .item{
      border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;background:#fff;
      transition: border-color .12s ease, box-shadow .12s ease, transform .05s ease;
      cursor:pointer;
      --pairColor:#93c5fd;
      --pairGlow: rgba(37,99,235,.12);
      --pairGlowStrong: rgba(37,99,235,.18);
    }
    .item:hover, .item.activeHover{
      border-color: var(--pairColor);
      box-shadow:0 10px 24px var(--pairGlow);
    }
    .item.selected{
      border-color: var(--pairColor);
      box-shadow:0 12px 28px var(--pairGlowStrong);
    }
    .item:active{ transform: translateY(1px); }

    .itemHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .itemTitleRow{display:flex;align-items:center;gap:10px;min-width:0;flex:1}

    .pairDot{
      width:10px;height:10px;border-radius:999px;background:var(--pairColor);
      box-shadow:0 0 0 3px rgba(15,23,42,.06);
      flex:0 0 auto;
    }
    .itemName{
      font-weight:1000;font-size:13px;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;max-width:100%;
    }
    .itemActions{display:flex;gap:8px;flex-wrap:nowrap;align-items:center}

    .itemDetails{
      display:none;margin-top:10px;padding-top:10px;border-top:1px solid #eef2f7;
      color:#475569;font-size:12px;line-height:1.45;
    }
    .item.expanded .itemDetails{ display:block; }

    .metaGrid{display:grid;grid-template-columns: 1fr 1fr;gap:6px 10px}
    .metaGrid .span2{grid-column:1/-1}
    .metaPill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;
      border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a;font-weight:900;font-size:11px;margin-top:10px;
    }
    .miniHint{font-size:11px;color:#64748b;margin-top:8px}

    /* ===== Preview ===== */
    #paperPreview{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      padding:0;
      margin:0;
    }

    .emptyPreview{
      width:100%;border:1px dashed #cbd5e1;border-radius:16px;background:#fafafa;
      padding:18px;max-width:760px;text-align:center;color:#334155;
    }
    .emptyPreview h4{margin:0 0 6px;font-size:14px}
    .emptyPreview p{margin:0;font-size:12px;color:#64748b;line-height:1.4}

    .page-shell{
      position:relative;
      width: calc(215.9mm * var(--previewScale, 0.58));
      height: calc(279.4mm * var(--previewScale, 0.58));
      background:#fff;border:1px solid var(--border);border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      overflow:hidden;
      transition: border-color .12s ease, box-shadow .12s ease;
      --pairColor:#93c5fd;
      --pairGlowStrong: rgba(37,99,235,.18);
    }
    .page-shell.hlpage{
      border-color: var(--pairColor);
      box-shadow:0 12px 28px var(--pairGlowStrong);
    }
    .pageLabel{
      position:absolute;top:10px;right:10px;
      font-size:11px;font-weight:1000;padding:5px 10px;border-radius:999px;
      background:rgba(15,23,42,.86);color:#fff;pointer-events:none;letter-spacing:.3px;
    }

    .page-inner{
      width:215.9mm;height:279.4mm;
      transform: scale(var(--previewScale, 0.58));
      transform-origin: top left;
    }

    .paper-page{
      width:215.9mm;height:279.4mm;
      padding: var(--pad, var(--padGrid));
      display:grid;
      gap: var(--gap, var(--gapGrid));
      background:#fff;
    }
    .paper-grid{ grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
    .paper-full{ --pad: var(--padFull); --gap: 0mm; grid-template-columns: 1fr; grid-template-rows: 1fr; }

    .slot{
      position:relative;display:flex;justify-content:center;align-items:center;
      overflow:hidden;border-radius:10px;cursor:pointer;
      --pairColor:#93c5fd;
      --pairGlowStrong: rgba(37,99,235,.18);
      background:#fff;
    }
    .slot img{width:100%;height:100%;object-fit:contain;display:block}

    .paper-full .slot{ padding: 2mm; }

    .pairMark{
      position:absolute;top:8px;left:8px;width:10px;height:10px;border-radius:999px;
      background: var(--pairColor);
      box-shadow:0 0 0 3px rgba(15,23,42,.06);
      pointer-events:none;
    }

    .slot.draft{
      outline:3px dashed #2563eb;outline-offset:-3px;
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }
    .draftTag{
      position:absolute;top:8px;left:8px;font-size:11px;font-weight:1000;
      padding:4px 8px;border-radius:999px;background:rgba(37,99,235,.92);color:#fff;pointer-events:none;
    }

    .slot.hl{
      outline:4px solid var(--pairColor);
      outline-offset:-4px;
      box-shadow:0 0 0 4px var(--pairGlowStrong);
    }
    .hlTag{
      position:absolute;bottom:8px;right:8px;font-size:11px;font-weight:1000;
      padding:4px 8px;border-radius:999px;background:var(--pairColor);color:#fff;pointer-events:none;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }

    #workCanvas{display:none}
    #__svgHostHidden{position:absolute;left:-99999px;top:-99999px}

    /* ===== Context menu ===== */
    .ctxMenu{
      position:fixed;z-index:99999;min-width:220px;background:#fff;border:1px solid #e5e7eb;
      border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.16);
      padding:8px;display:none;
    }
    .ctxTop{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;
      background:#f8fafc;border:1px solid #eef2f7;margin-bottom:8px;
    }
    .ctxDot{width:10px;height:10px;border-radius:999px;background:var(--pairColor,#93c5fd);flex:0 0 auto}
    .ctxTitle{font-weight:1000;font-size:12px;color:#0f172a;line-height:1.2;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ctxBtns{display:flex;flex-direction:column;gap:8px}
    .ctxBtns button{width:100%}
    .ctxHint{font-size:11px;color:#64748b;margin-top:6px;padding:0 4px}

    /* ===== MODAL ===== */
    .modalOverlay{
      position:fixed;inset:0;z-index:999999;
      background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 30px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;border-bottom:1px solid #eef2f7;background:#f8fafc;
    }
    .modalHead h4{margin:0;font-size:14px}
    .modalBody{padding:14px 14px;max-height:min(62vh, 520px);overflow:auto}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;padding:14px;border-top:1px solid #eef2f7;background:#fff}
    .modalText{font-size:13px;color:#0f172a;line-height:1.45}
    .errList{
      margin:12px 0 0;padding:0;list-style:none;
      display:flex;flex-direction:column;gap:8px;
    }
    .errList li{
      border:1px solid #fee2e2;background:#fef2f2;color:#991b1b;
      border-radius:12px;padding:10px 12px;font-size:12px;line-height:1.35;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;
      background:#f8fafc;font-size:11px;font-weight:900;color:#0f172a;
    }

    /* ===== IMPRESI√ìN ===== */
    @media print{
      html, body{
        margin:0 !important;
        padding:0 !important;
        background:#fff !important;
      }
      body{
        overflow:visible !important;
        height:auto !important;
      }

      body > :not(#printRoot){
        display:none !important;
      }

      #printRoot{
        display:block !important;
        position:static !important;
        width:215.9mm;
        margin:0 !important;
        padding:0 !important;
        background:#fff !important;
        overflow:visible !important;
      }

      *{
        -webkit-print-color-adjust:exact !important;
        print-color-adjust:exact !important;
      }

      .print-page{
        width:215.9mm !important;
        height:279.4mm !important;
        margin:0 !important;
        padding:0 !important;
        background:#fff !important;

        page-break-after: always;
        break-after: page;

        page-break-inside: avoid;
        break-inside: avoid;
      }
      .print-page:last-child{
        page-break-after:auto;
        break-after:auto;
      }

      .paper-page{ background:#fff !important; }
      .slot{ background:#fff !important; border-radius:0 !important; cursor:default !important; }

      @page{ size: letter portrait; margin:0; }
    }
  </style>
</head>
<body>

  <h2>Editor de etiqueta</h2>

  <div class="wrap" id="workspace">
    <!-- IZQUIERDA -->
    <div class="card" id="leftCard">
      <!-- LISTA -->
      <div id="listView">
        <div class="cardHeader">
          <div>
            <h3 style="margin:0">Productos</h3>
            <div class="subtle">Hover resalta ¬∑ Click mueve ¬∑ 1 desplegado</div>
          </div>

          <div class="btnRow" style="gap:8px">
            <button class="btnPrimary" id="btnShowForm" type="button">‚ûï Agregar</button>

            <!-- ‚úÖ Plantilla Excel -->
            <button class="btnIcon primary" id="btnTemplate" type="button" title="Descargar plantilla Excel" aria-label="Descargar plantilla Excel">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <path d="M7 10l5 5 5-5"/>
                <path d="M12 15V3"/>
              </svg>
            </button>

            <!-- ‚úÖ Importar Excel -->
            <button class="btnIcon primary" id="btnImport" type="button" title="Importar Excel" aria-label="Importar Excel">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <path d="M7 10l5-5 5 5"/>
                <path d="M12 5v14"/>
              </svg>
            </button>

            <button class="btnIcon primary" id="btnPdf" type="button" style="display:none" title="Exportar PDF" aria-label="Exportar PDF">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6"/>
                <path d="M8 13h8"/>
                <path d="M8 17h5"/>
              </svg>
            </button>

            <button class="btnIcon success" id="btnPrint" type="button" style="display:none" title="Imprimir" aria-label="Imprimir">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9V2h12v7"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <path d="M6 14h12v8H6z"/>
              </svg>
            </button>

            <button class="btnIcon danger" id="btnResetAll" type="button" style="display:none" title="Limpiar todo" aria-label="Limpiar todo">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 21h10"/>
                <path d="M16 3l5 5-11 11H5L2 16 16 3z"/>
                <path d="M15 4l5 5"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="leftScrollArea" id="listScrollArea">
          <div id="itemsWrap"></div>

          <p class="help">
            IDs en SVG:
            <b>nombre_producto</b>, <b>precio_antes</b>, <b>precio_ahora</b>, <b>cuota_semanal</b>,
            <b>fecha_vigencia</b> y <b>Fecha_impresion</b> (o <b>fecha_impresion</b>).
          </p>

          <p class="help">
            Excel esperado:
            <span class="pill">Plantilla</span>
            <span class="pill">Tama√±o</span>
            <span class="pill">Nombre</span>
            <span class="pill">Antes</span>
            <span class="pill">Ahora</span>
            <span class="pill">Cuota</span>
            <span class="pill">Cantidad</span>
            <span class="pill">AgregarVigencia</span>
            <span class="pill">VigenciaInicio</span>
            <span class="pill">VigenciaFin</span>
          </p>
        </div>
      </div>

      <!-- FORM -->
      <div id="formView" style="display:none">
        <div class="cardHeader">
          <div>
            <h3 id="formTitle" style="margin:0">Agregar producto</h3>
            <div class="subtle" id="formSubtitle">Completa todo para guardar</div>
          </div>
        </div>

        <div class="leftScrollArea" id="formScrollArea">
          <div class="form" id="formGrid">
            <div class="field">
              <label>Plantilla (SVG)</label>
              <select id="fTemplate" required>
                <option value="" selected disabled>Selecciona una plantilla‚Ä¶</option>
                <option value="promocion1.svg">Promoci√≥n</option>
                <option value="normal1.svg">Normal</option>
                <option value="liquidacion1.svg">Liquidaci√≥n</option>
                <option value="oferta1.svg">Oferta</option>
              </select>
              <div class="fieldError" id="eTemplate"></div>
            </div>

            <div class="field">
              <label>Tama√±o</label>
              <select id="fSize" required>
                <option value="" selected disabled>Selecciona un tama√±o‚Ä¶</option>
                <option value="quarter">1/4 (4 por hoja)</option>
                <option value="half_h">Media hoja horizontal (2 por hoja)</option>
                <option value="full">Carta completa (1 por hoja)</option>
              </select>
              <div class="fieldError" id="eSize"></div>
            </div>

            <div class="field span2">
              <label>Nombre</label>
              <input id="fNombre" placeholder="Ej: Laptop color rojo y verde" autocomplete="off">
              <div class="fieldError" id="eNombre"></div>
            </div>

            <div class="field">
              <label>Antes (entero, m√°x 5 d√≠gitos)</label>
              <input id="fAntes" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="Ej: 39999" autocomplete="off">
              <div class="fieldError" id="eAntes"></div>
            </div>

            <div class="field">
              <label>Ahora (entero, m√°x 5 d√≠gitos)</label>
              <input id="fAhora" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="Ej: 29999" autocomplete="off">
              <div class="fieldError" id="eAhora"></div>
            </div>

            <div class="field span2">
              <label>Cuota (entero, m√°x 5 d√≠gitos)</label>
              <input id="fCuota" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="Ej: 19999" autocomplete="off">
              <div class="fieldError" id="eCuota"></div>
            </div>

            <div class="field">
              <label>Cantidad</label>
              <input id="fQty" type="number" min="1" step="1" value="1">
              <div class="fieldError" id="eQty"></div>
            </div>

            <div class="field">
              <label>Vigencia</label>
              <div class="toggleRow">
                <input id="fUseVig" type="checkbox">
                <div>
                  <span>Agregar fecha de vigencia</span>
                  <small>Si lo marcas, debes elegir inicio y fin</small>
                </div>
              </div>
              <div class="fieldError" id="eVig"></div>
            </div>

            <div class="field span2" id="vigDates" style="display:none">
              <div class="form" style="grid-template-columns:1fr 1fr; gap:10px">
                <div class="field">
                  <label>Fecha inicial</label>
                  <input id="fVigStart" type="date">
                  <div class="fieldError" id="eVigStart"></div>
                </div>
                <div class="field">
                  <label>Fecha final</label>
                  <input id="fVigEnd" type="date">
                  <div class="fieldError" id="eVigEnd"></div>
                </div>
              </div>
            </div>
          </div>

          <p class="help">
            En edici√≥n/agregado, la previsualizaci√≥n marca el producto como gu√≠a (no se imprime).
          </p>
        </div>

        <div class="btnRow" style="margin-top:12px">
          <button class="btnSuccess" id="btnSave" type="button" disabled>üíæ Guardar</button>
          <button class="btnNeutral" id="btnCancel" type="button">‚Ü©Ô∏è Volver</button>
        </div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="card" id="paperPreviewWrap">
      <div id="paperPreview"></div>
    </div>
  </div>

  <div id="printRoot" style="display:none"></div>
  <canvas id="workCanvas"></canvas>
  <div id="__svgHostHidden"></div>

  <!-- Context menu -->
  <div id="ctxMenu" class="ctxMenu" role="menu" aria-hidden="true">
    <div class="ctxTop" id="ctxTop" style="--pairColor:#93c5fd">
      <div class="ctxDot" aria-hidden="true"></div>
      <div class="ctxTitle" id="ctxTitle">Producto</div>
    </div>
    <div class="ctxBtns">
      <button class="btnNeutral" id="ctxEdit" type="button">‚úèÔ∏è Editar</button>
      <button class="btnNeutral" id="ctxDelete" type="button" style="border-color:#fee2e2;color:#b91c1c;background:#fff">üóëÔ∏è Eliminar</button>
      <button class="btnNeutral" id="ctxClose" type="button">‚úñÔ∏è Cerrar</button>
    </div>
    <div class="ctxHint">Tip: click derecho en una etiqueta o producto.</div>
  </div>

  <!-- ‚úÖ Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h4 id="modalTitle">T√≠tulo</h4>
        <button class="btnIcon" id="modalX" type="button" title="Cerrar" aria-label="Cerrar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <!-- ‚úÖ Input archivo -->
  <input id="fileImport" type="file" accept=".xlsx,.xls" style="display:none">

<script>
  /* ============================
     Persistencia + alerta salida
  ============================ */
  const STORAGE_KEY = "editor_etiquetas_state_v6";
  let saveTimer = null;

  function requestSaveState(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveState, 180);
  }

  function saveState(){
    try{
      if (!isListView()) syncDraftFromForm();
      const state = { products, selectedProductId, expandedId, view: isListView()?"list":"form", formMode, editingId, draft };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){ console.warn("No se pudo guardar estado:", e); }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      const state = JSON.parse(raw);

      if (Array.isArray(state.products)) products = state.products;

      selectedProductId = state.selectedProductId || null;
      expandedId = state.expandedId || null;

      formMode = state.formMode || "add";
      editingId = state.editingId || null;
      draft = state.draft ? { ...emptyProduct(), ...state.draft } : emptyProduct();

      if (state.view === "form"){
        draft.impresionAt = draft.impresionAt || formatDateTimeNow();
        setView("form");
        $("formTitle").textContent = (formMode === "edit") ? "Editar producto" : "Agregar producto";
        $("formSubtitle").textContent = (formMode === "edit")
          ? "Al guardar, se actualiza la fecha y hora de impresi√≥n"
          : "Completa todo para guardar";
        fillFormFromProduct(draft);
        pendingFocus = { id: editingId ? editingId : "__draft__", scroll: true };
      } else {
        setView("list");
      }
      return true;
    }catch(e){
      console.warn("Estado corrupto:", e);
      return false;
    }
  }

  function clearState(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch{}
  }

  function hasWork(){
    if (products.length > 0) return true;
    if (!isListView()){
      syncDraftFromForm();
      return !!(draft.template || draft.size || draft.nombre || draft.antes || draft.ahora || draft.cuota || draft.useVig || (draft.qty && draft.qty > 1));
    }
    return false;
  }

  window.addEventListener("beforeunload", (e) => {
    if (!hasWork()) return;
    e.preventDefault();
    e.returnValue = "";
  });

  /* ============================
     App
  ============================ */
  const SVG_IDS = {
    nombre: "nombre_producto",
    antes: "precio_antes",
    ahora: "precio_ahora",
    cuota: "cuota_semanal",
    vigencia: "fecha_vigencia",
    impresionCandidates: ["Fecha_impresion", "fecha_impresion", "FECHA_IMPRESION"],
  };

  const PREVIEW_SCALE = 0.58;

  let products = [];
  let editingId = null;
  let formMode = "add";
  let draft = emptyProduct();

  const templateTextCache = new Map();
  const renderCache = new Map();
  const imgDimCache = new Map();

  let previewTimer = null;

  let previewSlotsByProduct = new Map();
  let activeItemEl = null;

  let expandedId = null;
  let selectedProductId = null;

  let hoverTimer = null;
  let hoverOutTimer = null;
  let hoverPid = null;

  let ctxPid = null;

  let pendingFocus = null;

  let exporting = false;
  let importing = false;

  const $ = (id) => document.getElementById(id);

  function cssEsc(s){
    try{
      return (window.CSS && CSS.escape) ? CSS.escape(String(s)) : String(s).replace(/[^a-zA-Z0-9_\-]/g, "\\$&");
    }catch{
      return String(s);
    }
  }
  function uid(){ return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

  function emptyProduct(){
    return {
      id: null, template: "", size: "",
      nombre: "", antes: "", ahora: "", cuota: "",
      qty: 1,
      useVig: false, vigStart: "", vigEnd: "",
      impresionAt: "",
      colorIdx: null,
    };
  }

  function onlyDigits(str){ return (str ?? "").toString().replace(/[^\d]/g, ""); }

  /* ‚úÖ 5 d√≠gitos */
  function sanitizeIntStr(raw){
    let cleaned = onlyDigits(raw).slice(0, 5);
    if (cleaned.length > 1) cleaned = cleaned.replace(/^0+/, "") || "0";
    return cleaned;
  }

  function formatThousands(num){
    try { return Number(num).toLocaleString("en-US"); }
    catch { return String(num||"").replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  }
  function toQuetzales(digits){
    if (!digits) return "";
    const n = parseInt(digits, 10);
    if (!Number.isFinite(n)) return "";
    return "Q " + formatThousands(n);
  }
  function formatDMY(iso){
    if (!iso) return "";
    const [y,m,d] = iso.split("-");
    if (!y || !m || !d) return iso;
    return `${d}/${m}/${y}`;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function formatDateTimeNow(){
    const dt = new Date();
    const d = pad2(dt.getDate());
    const m = pad2(dt.getMonth()+1);
    const y = dt.getFullYear();
    const hh = pad2(dt.getHours());
    const mm = pad2(dt.getMinutes());
    return `${d}/${m}/${y} ${hh}:${mm}`;
  }

  function showEmptyPreview(title, body){
    $("paperPreview").innerHTML = `
      <div class="emptyPreview">
        <h4>${title}</h4>
        <p>${body}</p>
      </div>
    `;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  /* ============================
     ‚úÖ MODAL
  ============================ */
  function openModal({ title, bodyHtml, actions }){
    $("modalTitle").textContent = title || "Mensaje";
    $("modalBody").innerHTML = bodyHtml || "";
    const actionsWrap = $("modalActions");
    actionsWrap.innerHTML = "";

    (actions || []).forEach(a => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = a.className || "btnNeutral";
      btn.textContent = a.text || "OK";
      btn.addEventListener("click", () => {
        if (a.onClick) a.onClick();
      });
      actionsWrap.appendChild(btn);
    });

    $("modalOverlay").style.display = "flex";
    $("modalOverlay").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("modalOverlay").style.display = "none";
    $("modalOverlay").setAttribute("aria-hidden","true");
    $("modalBody").innerHTML = "";
    $("modalActions").innerHTML = "";
  }
  $("modalX").addEventListener("click", closeModal);
  $("modalOverlay").addEventListener("click", (e)=>{
    if (e.target === $("modalOverlay")) closeModal();
  });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  /* ============================
     ‚úÖ COLORES
  ============================ */
  const COLOR_HUES = [210,150,35,0,270,190,95,235,25,330];

  function allocateColorIdx(baseProducts = products){
    const used = new Set(baseProducts.map(p => p.colorIdx).filter(n => Number.isFinite(n)));
    let idx = 0;
    while (used.has(idx)) idx++;
    return idx;
  }

  function colorFromIdx(idx){
    const base = idx % COLOR_HUES.length;
    const variant = Math.floor(idx / COLOR_HUES.length);
    const hue = (COLOR_HUES[base] + (variant * 7)) % 360;

    const satArr = [82, 78, 86, 80];
    const litArr = [46, 56, 38, 50];
    const sat = satArr[variant % satArr.length];
    const lit = litArr[variant % litArr.length];

    return `hsl(${hue} ${sat}% ${lit}%)`;
  }

  function glowFromIdx(idx, strong=false){
    const base = idx % COLOR_HUES.length;
    const variant = Math.floor(idx / COLOR_HUES.length);
    const hue = (COLOR_HUES[base] + (variant * 7)) % 360;
    const a = strong ? 0.22 : 0.14;
    return `hsla(${hue} 85% 45% / ${a})`;
  }

  function findProduct(pid){
    if (!pid) return null;
    if (editingId && pid === editingId) return draft;
    return products.find(p => p.id === pid) || null;
  }

  function pairColor(pid){
    const p = findProduct(pid);
    const idx = Number.isFinite(p?.colorIdx) ? p.colorIdx : 0;
    return colorFromIdx(idx);
  }
  function pairGlow(pid, strong=false){
    const p = findProduct(pid);
    const idx = Number.isFinite(p?.colorIdx) ? p.colorIdx : 0;
    return glowFromIdx(idx, strong);
  }

  /* ========= Scroll SOLO dentro de contenedores ========= */
  function scrollToChild(container, child, pad=16){
    if (!container || !child) return;
    const c = container.getBoundingClientRect();
    const r = child.getBoundingClientRect();
    const target = container.scrollTop + (r.top - c.top) - pad;
    container.scrollTo({ top: target, behavior: "smooth" });
  }

  function isElementInView(container, el, margin=10){
    if (!container || !el) return false;
    const c = container.getBoundingClientRect();
    const r = el.getBoundingClientRect();
    return (r.top >= c.top + margin) && (r.bottom <= c.bottom - margin);
  }

  function setFieldError(inputId, errorId, msg){
    const input = $(inputId);
    const err = $(errorId);
    if (!input || !err) return;
    const has = !!msg;
    err.textContent = msg || "";
    err.classList.toggle("show", has);
    input.classList.toggle("isInvalid", has);
  }
  function clearAllErrors(){
    setFieldError("fTemplate","eTemplate","");
    setFieldError("fSize","eSize","");
    setFieldError("fNombre","eNombre","");
    setFieldError("fAntes","eAntes","");
    setFieldError("fAhora","eAhora","");
    setFieldError("fCuota","eCuota","");
    setFieldError("fQty","eQty","");
    setFieldError("fUseVig","eVig","");
    setFieldError("fVigStart","eVigStart","");
    setFieldError("fVigEnd","eVigEnd","");
  }

  function isListView(){ return $("listView").style.display !== "none"; }

  function updateTopButtonsVisibility(){
    const has = products.length > 0;
    $("btnPrint").style.display = has ? "inline-flex" : "none";
    $("btnPdf").style.display   = has ? "inline-flex" : "none";
    $("btnResetAll").style.display = has ? "inline-flex" : "none";
  }

  function clearAllHoverState(){
    clearTimeout(hoverTimer);
    clearTimeout(hoverOutTimer);
    hoverPid = null;

    if (activeItemEl) activeItemEl.classList.remove("activeHover");
    activeItemEl = null;

    clearPreviewHighlight();
  }

  function setView(view){
    if (view === "list"){
      $("listView").style.display = "flex";
      $("formView").style.display = "none";
      updateTopButtonsVisibility();
      renderItemsList();
      schedulePreviewRebuild();
    } else {
      clearAllHoverState();
      $("listView").style.display = "none";
      $("formView").style.display = "flex";
      $("btnPrint").style.display = "none";
      $("btnPdf").style.display   = "none";
      $("btnResetAll").style.display = "none";
      hideCtxMenu();
      schedulePreviewRebuild();
    }
    requestSaveState();
  }

  function isExpanded(id){ return expandedId === id; }
  function setExpanded(id){ expandedId = id || null; }
  function toggleExpanded(id){ expandedId = (expandedId === id) ? null : id; }

  function clearPreviewHighlight(){
    document.querySelectorAll(".slot.hl").forEach(el => {
      el.classList.remove("hl");
      const tag = el.querySelector(".hlTag");
      if (tag) tag.remove();
    });
    document.querySelectorAll(".page-shell.hlpage").forEach(el => {
      el.classList.remove("hlpage");
      el.style.removeProperty("--pairColor");
      el.style.removeProperty("--pairGlowStrong");
    });
  }

  function setActiveListItem(el){
    if (activeItemEl && activeItemEl !== el) activeItemEl.classList.remove("activeHover");
    activeItemEl = el || null;
    if (activeItemEl) activeItemEl.classList.add("activeHover");
  }
  function clearListHover(){ setActiveListItem(null); }

  function markSelectedInList(){
    document.querySelectorAll(".item.selected").forEach(el => el.classList.remove("selected"));
    if (!selectedProductId) return;
    const item = document.querySelector(`.item[data-id="${cssEsc(selectedProductId)}"]`);
    if (item) item.classList.add("selected");
  }

  function highlightProductInList(productId, scroll=false){
    if (!productId) return;
    const item = document.querySelector(`.item[data-id="${cssEsc(productId)}"]`);
    if (!item) return;
    setActiveListItem(item);

    if (scroll){
      const container = $("listScrollArea");
      if (container) scrollToChild(container, item, 24);
      else item.scrollIntoView({ behavior:"smooth", block:"center" });
    }
  }

  function highlightProductInPreview(productId, scroll=false, showTag=null){
    if (!productId) return;

    clearPreviewHighlight();

    const slots = previewSlotsByProduct.get(productId) || [];
    if (!slots.length) return;

    const c = pairColor(productId);
    const g = pairGlow(productId, true);

    const canShowTag = (showTag === null) ? isListView() : !!showTag;

    slots.forEach((slot, idx) => {
      slot.classList.add("hl");
      slot.style.setProperty("--pairColor", c);
      slot.style.setProperty("--pairGlowStrong", g);

      if (canShowTag && idx === 0){
        const tag = document.createElement("div");
        tag.className = "hlTag";
        tag.textContent = "AQU√ç";
        slot.appendChild(tag);
      }

      const shell = slot.closest(".page-shell");
      if (shell){
        shell.classList.add("hlpage");
        shell.style.setProperty("--pairColor", c);
        shell.style.setProperty("--pairGlowStrong", g);
      }
    });

    if (scroll){
      const shell = slots[0].closest(".page-shell");
      if (shell) scrollToChild($("paperPreviewWrap"), shell, 24);
    }
  }

  function ensureDraftVisible(){
    if (isListView()) return;
    const wrap = $("paperPreviewWrap");
    const slot = document.querySelector(".slot.draft");
    if (!wrap || !slot) return;
    const shell = slot.closest(".page-shell");
    if (!shell) return;

    if (!isElementInView(wrap, shell, 18)){
      scrollToChild(wrap, shell, 24);
    }
  }

  function applySelectionHighlight(){
    if (!selectedProductId){
      clearPreviewHighlight();
      clearListHover();
      markSelectedInList();
      return;
    }
    highlightProductInPreview(selectedProductId, false);
    highlightProductInList(selectedProductId, false);
    markSelectedInList();
  }

  function scheduleHover(pid){
    if (!pid) return;
    clearTimeout(hoverTimer);
    clearTimeout(hoverOutTimer);
    hoverPid = pid;

    hoverTimer = setTimeout(() => {
      if (hoverPid !== pid) return;
      highlightProductInPreview(pid, false, true);
      highlightProductInList(pid, false);
    }, 140);
  }
  function scheduleHoverClear(){
    clearTimeout(hoverTimer);
    clearTimeout(hoverOutTimer);

    hoverOutTimer = setTimeout(() => {
      hoverPid = null;
      applySelectionHighlight();
    }, 180);
  }

  /* ===== Context Menu ===== */
  function placeCtxMenu(x, y){
    const menu = $("ctxMenu");
    const pad = 10;
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    menu.style.display = "block";
    menu.style.left = "0px";
    menu.style.top = "0px";

    const rect = menu.getBoundingClientRect();
    let nx = x;
    let ny = y;

    if (nx + rect.width + pad > vw) nx = vw - rect.width - pad;
    if (ny + rect.height + pad > vh) ny = vh - rect.height - pad;
    if (nx < pad) nx = pad;
    if (ny < pad) ny = pad;

    menu.style.left = nx + "px";
    menu.style.top = ny + "px";
  }

  function showCtxMenu(pid, x, y){
    if (!pid || !isListView()) return;
    ctxPid = pid;

    const p = products.find(pp => pp.id === pid);
    const name = p?.nombre || "Producto";

    const c = pairColor(pid);
    $("ctxTop").style.setProperty("--pairColor", c);
    $("ctxTitle").textContent = name;

    selectedProductId = pid;
    setExpanded(pid);
    renderItemsList();
    requestAnimationFrame(() => applySelectionHighlight());

    placeCtxMenu(x, y);
    $("ctxMenu").setAttribute("aria-hidden","false");
    requestSaveState();
  }

  function hideCtxMenu(){
    ctxPid = null;
    const menu = $("ctxMenu");
    menu.style.display = "none";
    menu.setAttribute("aria-hidden","true");
  }

  document.addEventListener("click", (e)=>{
    const menu = $("ctxMenu");
    if (menu.style.display === "none") return;
    if (menu.contains(e.target)) return;
    hideCtxMenu();
  });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") hideCtxMenu(); });
  window.addEventListener("scroll", ()=> hideCtxMenu(), true);

  $("ctxClose").addEventListener("click", (e)=>{ e.stopPropagation(); hideCtxMenu(); });
  $("ctxEdit").addEventListener("click", (e)=>{
    e.stopPropagation();
    const pid = ctxPid;
    hideCtxMenu();
    if (pid) onEditProduct(pid, { fromCtx: true });
  });
  $("ctxDelete").addEventListener("click", (e)=>{
    e.stopPropagation();
    const pid = ctxPid;
    hideCtxMenu();
    if (pid) onDeleteProduct(pid);
  });

  /* ===== Iconos ===== */
  const ICONS = {
    chevronRight: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>`,
    chevronDown: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>`,
    edit: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>`,
    trash: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 16h10l1-16"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>`
  };

  /* ===== List UI ===== */
  function renderItemsList(){
    const wrap = $("itemsWrap");

    if (products.length === 0){
      wrap.innerHTML = `
        <div class="listEmpty">
          No hay productos agregados todav√≠a.<br>
          Presiona <b>‚ÄúAgregar‚Äù</b> o usa <b>Importar Excel</b>.
        </div>
      `;
      return;
    }

    wrap.innerHTML = `
      <div class="items" id="itemsList">
        ${products.map(p => {
          const isOpen = isExpanded(p.id);
          const chevron = isOpen ? ICONS.chevronDown : ICONS.chevronRight;

          const sizeLabel = p.size === "quarter" ? "1/4" : (p.size === "half_h" ? "Media horiz." : "Carta");
          const vigLabel = p.useVig ? `Vigencia: ${formatDMY(p.vigStart)} ‚Üí ${formatDMY(p.vigEnd)}` : "Sin vigencia";
          const impLabel = p.impresionAt ? `Impresi√≥n: ${p.impresionAt}` : "Impresi√≥n: (pendiente)";

          const c = pairColor(p.id);
          const g = pairGlow(p.id, false);
          const gs = pairGlow(p.id, true);

          return `
            <div class="item ${isOpen ? "expanded" : ""}"
                 data-id="${p.id}"
                 style="--pairColor:${c}; --pairGlow:${g}; --pairGlowStrong:${gs}"
                 tabindex="0">

              <div class="itemHead">
                <div class="itemTitleRow" data-role="title">
                  <button class="btnIcon" type="button" data-action="toggle" title="${isOpen ? "Plegar" : "Desplegar"}" aria-label="${isOpen ? "Plegar" : "Desplegar"}">
                    ${chevron}
                  </button>
                  <div class="pairDot" aria-hidden="true"></div>
                  <div class="itemName" data-role="name" title="${escapeHtml(p.nombre || "(Sin nombre)")}">
                    ${escapeHtml(p.nombre || "(Sin nombre)")}
                  </div>
                </div>

                <div class="itemActions">
                  <button class="btnIcon warning" type="button" data-action="edit" title="Editar" aria-label="Editar">
                    ${ICONS.edit}
                  </button>
                  <button class="btnIcon danger" type="button" data-action="delete" title="Eliminar" aria-label="Eliminar">
                    ${ICONS.trash}
                  </button>
                </div>
              </div>

              <div class="itemDetails">
                <div class="metaGrid">
                  <div><b>Plantilla:</b> ${escapeHtml(p.template)}</div>
                  <div><b>Tama√±o:</b> ${escapeHtml(sizeLabel)}</div>
                  <div><b>Cantidad:</b> ${p.qty}</div>
                  <div><b>Cuota:</b> ${escapeHtml(toQuetzales(p.cuota))}</div>
                  <div><b>Antes:</b> ${escapeHtml(toQuetzales(p.antes))}</div>
                  <div><b>Ahora:</b> ${escapeHtml(toQuetzales(p.ahora))}</div>
                  <div class="span2"><b>${escapeHtml(vigLabel)}</b></div>
                  <div class="span2">${escapeHtml(impLabel)}</div>
                </div>

                <div class="metaPill">üí° Hover = resalta ¬∑ Click = mover</div>
                <div class="miniHint">Click en una etiqueta del preview: abre este producto aqu√≠.</div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    markSelectedInList();
  }

  $("itemsWrap").addEventListener("mouseover", (e)=>{
    const item = e.target.closest?.(".item[data-id]");
    if (!item || !isListView()) return;
    scheduleHover(item.dataset.id);
  });

  $("itemsWrap").addEventListener("mouseout", (e)=>{
    const item = e.target.closest?.(".item[data-id]");
    if (!item) return;
    if (item.contains(e.relatedTarget)) return;
    const toSlot = e.relatedTarget?.closest?.(".slot[data-product-id]");
    if (toSlot) return;
    scheduleHoverClear();
  });

  $("itemsWrap").addEventListener("contextmenu", (e)=>{
    const item = e.target.closest?.(".item[data-id]");
    if (!item || !isListView()) return;
    e.preventDefault();
    showCtxMenu(item.dataset.id, e.clientX, e.clientY);
  });

  $("itemsWrap").addEventListener("click", (e)=>{
    const item = e.target.closest?.(".item[data-id]");
    if (!item || !isListView()) return;

    const pid = item.dataset.id;
    const actionBtn = e.target.closest?.("[data-action]");

    if (actionBtn){
      const action = actionBtn.dataset.action;

      if (action === "toggle"){
        e.stopPropagation();
        selectedProductId = pid;

        toggleExpanded(pid);
        renderItemsList();

        const opened = (expandedId === pid);
        requestAnimationFrame(() => {
          markSelectedInList();
          highlightProductInPreview(pid, opened, true);
          highlightProductInList(pid, false);
        });

        requestSaveState();
        return;
      }

      if (action === "edit"){
        e.stopPropagation();
        onEditProduct(pid, { fromCtx:false });
        return;
      }
      if (action === "delete"){
        e.stopPropagation();
        onDeleteProduct(pid);
        return;
      }
    }

    const inTitle = !!e.target.closest?.('[data-role="title"]') || !!e.target.closest?.('[data-role="name"]');
    selectedProductId = pid;

    if (inTitle){
      toggleExpanded(pid);
      renderItemsList();
      const opened = (expandedId === pid);
      requestAnimationFrame(() => {
        markSelectedInList();
        highlightProductInPreview(pid, opened, true);
        highlightProductInList(pid, false);
      });
      requestSaveState();
      return;
    }

    setExpanded(pid);
    renderItemsList();
    requestAnimationFrame(() => {
      markSelectedInList();
      highlightProductInPreview(pid, true, true);
      highlightProductInList(pid, false);
    });
    requestSaveState();
  });

  $("paperPreview").addEventListener("mouseover", (e)=>{
    const slot = e.target.closest?.(".slot[data-product-id]");
    if (!slot || !isListView()) return;
    const pid = slot.dataset.productId || "";
    if (!pid || pid === "__draft__") return;
    scheduleHover(pid);
  });

  $("paperPreview").addEventListener("mouseout", (e)=>{
    const fromSlot = e.target.closest?.(".slot[data-product-id]");
    if (!fromSlot) return;

    const toSlot = e.relatedTarget?.closest?.(".slot[data-product-id]");
    if (toSlot) return;

    const toItem = e.relatedTarget?.closest?.(".item[data-id]");
    if (toItem) return;

    scheduleHoverClear();
  });

  $("paperPreview").addEventListener("contextmenu", (e)=>{
    const slot = e.target.closest?.(".slot[data-product-id]");
    if (!slot || !isListView()) return;

    const pid = slot.dataset.productId || "";
    if (!pid || pid === "__draft__") return;

    e.preventDefault();
    showCtxMenu(pid, e.clientX, e.clientY);
  });

  $("paperPreview").addEventListener("click", (e)=>{
    const slot = e.target.closest?.(".slot[data-product-id]");
    if (!slot || !isListView()) return;

    const pid = slot.dataset.productId || "";
    if (!pid || pid === "__draft__") return;

    selectedProductId = pid;
    setExpanded(pid);
    renderItemsList();

    requestAnimationFrame(()=>{
      highlightProductInList(pid, true);
      markSelectedInList();
      highlightProductInPreview(pid, false, true);
    });
    requestSaveState();
  });

  /* ===== Form sync/validation ===== */
  function syncDraftFromForm(){
    draft.template = $("fTemplate").value || "";
    draft.size = $("fSize").value || "";
    draft.nombre = ($("fNombre").value || "").trim();

    draft.antes = sanitizeIntStr($("fAntes").value);
    draft.ahora = sanitizeIntStr($("fAhora").value);
    draft.cuota = sanitizeIntStr($("fCuota").value);
    $("fAntes").value = draft.antes;
    $("fAhora").value = draft.ahora;
    $("fCuota").value = draft.cuota;

    const q = parseInt($("fQty").value, 10);
    draft.qty = Number.isFinite(q) && q > 0 ? q : 0;

    draft.useVig = !!$("fUseVig").checked;
    $("vigDates").style.display = draft.useVig ? "block" : "none";
    draft.vigStart = $("fVigStart").value || "";
    draft.vigEnd = $("fVigEnd").value || "";
  }

  function validateProductData(p){
    const errs = [];

    if (!p.template) errs.push("Plantilla requerida.");
    if (!p.size) errs.push("Tama√±o requerido.");
    if (!p.nombre || !p.nombre.trim()) errs.push("Nombre requerido.");

    const antes = sanitizeIntStr(p.antes || "");
    const ahora = sanitizeIntStr(p.ahora || "");
    const cuota = sanitizeIntStr(p.cuota || "");

    if (!antes) errs.push("Antes requerido (m√°x 5 d√≠gitos).");
    if (!ahora) errs.push("Ahora requerido (m√°x 5 d√≠gitos).");
    if (!cuota) errs.push("Cuota requerida (m√°x 5 d√≠gitos).");

    const qty = parseInt(p.qty, 10);
    if (!Number.isFinite(qty) || qty < 1) errs.push("Cantidad debe ser mayor a 0.");

    if (antes && ahora){
      const aN = parseInt(antes, 10);
      const hN = parseInt(ahora, 10);
      if (Number.isFinite(aN) && Number.isFinite(hN) && hN > aN){
        errs.push("'Ahora' no puede ser mayor que 'Antes'.");
      }
    }

    if (p.useVig){
      if (!p.vigStart) errs.push("VigenciaInicio requerida.");
      if (!p.vigEnd) errs.push("VigenciaFin requerida.");
      if (p.vigStart && p.vigEnd && p.vigEnd < p.vigStart) errs.push("VigenciaFin no puede ser menor que VigenciaInicio.");
    }

    return errs;
  }

  function validateDraft(){
    clearAllErrors();
    syncDraftFromForm();

    const errs = validateProductData(draft);

    if (!draft.template) setFieldError("fTemplate","eTemplate","Selecciona una plantilla.");
    if (!draft.size) setFieldError("fSize","eSize","Selecciona un tama√±o.");
    if (!draft.nombre) setFieldError("fNombre","eNombre","Este campo es obligatorio.");
    if (!draft.antes) setFieldError("fAntes","eAntes","Ingresa 'Antes' (m√°x 5 d√≠gitos).");
    if (!draft.ahora) setFieldError("fAhora","eAhora","Ingresa 'Ahora' (m√°x 5 d√≠gitos).");
    if (!draft.cuota) setFieldError("fCuota","eCuota","Ingresa 'Cuota' (m√°x 5 d√≠gitos).");
    if (!draft.qty || draft.qty < 1) setFieldError("fQty","eQty","Cantidad debe ser mayor a 0.");

    if (draft.antes && draft.ahora){
      const antesN = parseInt(draft.antes, 10);
      const ahoraN = parseInt(draft.ahora, 10);
      if (Number.isFinite(antesN) && Number.isFinite(ahoraN) && ahoraN > antesN){
        setFieldError("fAhora","eAhora","'Ahora' no puede ser mayor que 'Antes'.");
      }
    }

    if (draft.useVig){
      if (!draft.vigStart) setFieldError("fVigStart","eVigStart","Selecciona fecha inicial.");
      if (!draft.vigEnd) setFieldError("fVigEnd","eVigEnd","Selecciona fecha final.");
      if (draft.vigStart && draft.vigEnd && draft.vigEnd < draft.vigStart){
        setFieldError("fVigEnd","eVigEnd","La fecha final no puede ser menor que la inicial.");
      }
    }

    const ok = errs.length === 0;
    $("btnSave").disabled = !ok;
    requestSaveState();
    return ok;
  }

  function fillFormFromProduct(p){
    $("fTemplate").value = p.template || "";
    $("fSize").value = p.size || "";
    $("fNombre").value = p.nombre || "";
    $("fAntes").value = p.antes || "";
    $("fAhora").value = p.ahora || "";
    $("fCuota").value = p.cuota || "";
    $("fQty").value = String(p.qty || 1);

    $("fUseVig").checked = !!p.useVig;
    $("vigDates").style.display = p.useVig ? "block" : "none";
    $("fVigStart").value = p.vigStart || "";
    $("fVigEnd").value = p.vigEnd || "";

    syncDraftFromForm();
    validateDraft();
  }

  /* ===== Actions ===== */
  window.onEditProduct = (id) => {
    const p = products.find(x => x.id === id);
    if (!p) return;

    clearAllHoverState();
    scheduleHoverClear();

    setExpanded(null);
    hideCtxMenu();

    editingId = id;
    formMode = "edit";

    draft = { ...p };
    draft.impresionAt = formatDateTimeNow();

    $("formTitle").textContent = "Editar producto";
    $("formSubtitle").textContent = "Al guardar, se actualiza la fecha y hora de impresi√≥n";
    fillFormFromProduct(draft);

    setView("form");

    pendingFocus = { id, scroll:true };
    schedulePreviewRebuild();
    requestSaveState();
  };

  window.onDeleteProduct = (id) => {
    const p = products.find(x => x.id === id);
    if (!p) return;
    hideCtxMenu();

    if (!confirm(`¬øEliminar "${p.nombre}"?`)) return;

    if (expandedId === id) expandedId = null;
    if (selectedProductId === id) selectedProductId = null;

    products = products.filter(x => x.id !== id);

    updateTopButtonsVisibility();
    renderItemsList();
    schedulePreviewRebuild();
    requestSaveState();
  };

  function openAddForm(){
    clearAllHoverState();
    scheduleHoverClear();

    setExpanded(null);
    selectedProductId = null;
    clearListHover();
    hideCtxMenu();

    editingId = null;
    formMode = "add";
    draft = emptyProduct();
    draft.impresionAt = formatDateTimeNow();

    $("formTitle").textContent = "Agregar producto";
    $("formSubtitle").textContent = "Completa todo para guardar";

    $("fTemplate").value = "";
    $("fSize").value = "";
    $("fNombre").value = "";
    $("fAntes").value = "";
    $("fAhora").value = "";
    $("fCuota").value = "";
    $("fQty").value = "1";
    $("fUseVig").checked = false;
    $("fVigStart").value = "";
    $("fVigEnd").value = "";
    $("vigDates").style.display = "none";

    clearAllErrors();
    $("btnSave").disabled = true;

    setView("form");

    pendingFocus = { id: "__draft__", scroll:true };
    schedulePreviewRebuild();
    requestSaveState();
  }

  function backToList(){
    editingId = null;
    formMode = "add";
    draft = emptyProduct();
    setView("list");
    requestSaveState();
  }

  function saveDraft(){
    if (!validateDraft()) return;

    const nowText = formatDateTimeNow();
    let savedId = null;

    if (formMode === "add"){
      const p = { ...draft };
      p.id = uid();
      p.impresionAt = nowText;
      p.colorIdx = allocateColorIdx();
      products.push(p);
      savedId = p.id;
    } else {
      const idx = products.findIndex(x => x.id === editingId);
      if (idx >= 0){
        const p = { ...draft };
        p.id = editingId;
        p.impresionAt = nowText;
        p.colorIdx = Number.isFinite(products[idx].colorIdx) ? products[idx].colorIdx : (Number.isFinite(draft.colorIdx) ? draft.colorIdx : allocateColorIdx());
        products[idx] = p;
        savedId = p.id;
      }
    }

    selectedProductId = savedId;
    setExpanded(savedId);

    updateTopButtonsVisibility();
    renderItemsList();
    backToList();
    schedulePreviewRebuild();

    requestAnimationFrame(() => applySelectionHighlight());
    requestSaveState();
  }

  function resetAll(){
    if (products.length === 0) return;
    if (!confirm("¬øEliminar TODOS los productos guardados?")) return;

    hideCtxMenu();
    products = [];
    expandedId = null;
    selectedProductId = null;

    updateTopButtonsVisibility();
    renderItemsList();
    renderCache.clear();
    previewSlotsByProduct.clear();
    showEmptyPreview("Sin previsualizaci√≥n", "Agrega productos para ver c√≥mo se acomodan en las hojas.");

    clearState();
  }

  /* ============================
     ‚úÖ Helpers: Plantillas sin extensi√≥n
  ============================ */
  function normalizeText(s){
    const t = (s ?? "").toString().trim().toLowerCase();
    try{
      return t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }catch{
      return t;
    }
  }
  function stripExt(name){
    const s = (name ?? "").toString().trim();
    const dot = s.lastIndexOf(".");
    return (dot > 0) ? s.slice(0, dot) : s;
  }
  function normalizeTemplateBase(v){
    return normalizeText(stripExt(v)).replace(/\s+/g,"");
  }

  function getAllowedTemplates(){
    const sel = $("fTemplate");
    const vals = Array.from(sel.options).map(o => o.value).filter(Boolean);
    return vals;
  }
  function getAllowedTemplateBases(){
    return getAllowedTemplates().map(t => stripExt(t));
  }

  /* ============================
     ‚úÖ Plantilla Excel (DESCARGA)
     - Plantilla sin .svg
     - Tama√±o en espa√±ol
     - Fechas DD/MM/AAAA
     - 1 ejemplo por cada plantilla
     - Nombre incluye [DAF###########]
  ============================ */
  function downloadExcelTemplate(){
    if (!window.XLSX){
      alert("No se pudo cargar XLSX. Revisa el CDN.");
      return;
    }

    const headers = ["Plantilla","Tama√±o","Nombre","Antes","Ahora","Cuota","Cantidad","AgregarVigencia","VigenciaInicio","VigenciaFin"];

    // ‚úÖ 1 ejemplo por cada plantilla
    // Plantilla: SOLO nombre sin .svg
    // Tama√±o: en espa√±ol (mejor gu√≠a)
    // Fechas: DD/MM/AAAA
    const examples = [
      ["normal1","1/4","AUD√çFONOS BLUETOOTH [DAF4561546401]","199","149","25","4","NO","",""],
      ["promocion1","MEDIA HORIZONTAL","LAPTOP DELL I5 8GB 256SSD [DAF4561546402]","9999","8999","250","2","SI","01/01/2026","31/01/2026"],
      ["liquidacion1","1/4","TENIS NIKE AIR MAX [DAF4561546403]","1299","999","75","4","SI","05/02/2026","20/02/2026"],
      ["oferta1","CARTA COMPLETA","SMART TV 55 PULGADAS [DAF4561546404]","15000","12999","450","1","SI","01/03/2026","15/03/2026"]
    ];

    const aoaImportar = [headers, ...examples];
    const wsImportar = XLSX.utils.aoa_to_sheet(aoaImportar);
    wsImportar["!cols"] = [
      { wch: 14 }, { wch: 18 }, { wch: 44 }, { wch: 10 }, { wch: 10 }, { wch: 10 },
      { wch: 10 }, { wch: 18 }, { wch: 16 }, { wch: 16 }
    ];

    const allowedBases = getAllowedTemplateBases().join(" | ");
    const notes = [
      ["NOTAS / AYUDA"],
      [""],
      ["Objetivo:", "Rellenar la hoja 'Importar' y luego usar el bot√≥n 'Importar Excel' en el sistema."],
      [""],
      ["Columnas requeridas:", "Plantilla, Tama√±o, Nombre, Antes, Ahora, Cuota, Cantidad"],
      [""],
      ["PLANTILLA (sin .svg):", "Escribe solo el nombre. Ej: promocion1"],
      ["Plantillas disponibles en este sistema:", allowedBases || "promocion1 | normal1 | liquidacion1 | oferta1"],
      ["Tambi√©n se aceptan alias:", "Normal | Promoci√≥n | Liquidaci√≥n | Oferta"],
      [""],
      ["TAMA√ëO (recomendado en espa√±ol):", "1/4 | MEDIA HORIZONTAL | CARTA COMPLETA"],
      ["Tambi√©n se aceptan:", "quarter | half_h | full, y variantes como 'media', 'carta', 'mitad', 'cuarto'"],
      [""],
      ["ANTES / AHORA / CUOTA:", "Solo n√∫meros enteros, m√°ximo 5 d√≠gitos. Ej: 9999"],
      ["CANTIDAD:", "Entero > 0. Ej: 4"],
      [""],
      ["AGREGAR VIGENCIA:", "SI / NO. Si es SI, VigenciaInicio y VigenciaFin son obligatorias."],
      ["FECHAS (VigenciaInicio/VigenciaFin):", "Formato recomendado: DD/MM/AAAA. Ej: 31/01/2026"],
      ["Reglas de fechas:", "VigenciaFin no puede ser menor que VigenciaInicio."],
      [""],
      ["Reglas de precio:", "AHORA no puede ser mayor que ANTES."],
      [""],
      ["Importante:", "Si una fila tiene error, se rechaza todo el archivo (no se crea nada)."]
    ];
    const wsNotas = XLSX.utils.aoa_to_sheet(notes);
    wsNotas["!cols"] = [{ wch: 30 }, { wch: 78 }];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsImportar, "Importar");
    XLSX.utils.book_append_sheet(wb, wsNotas, "Notas");

    XLSX.writeFile(wb, "plantilla_importacion_etiquetas.xlsx");
  }

  /* ============================
     ‚úÖ IMPORTACI√ìN EXCEL
     - Plantilla sin extensi√≥n
     - Tama√±o en espa√±ol
     - Fechas DD/MM/AAAA
  ============================ */
  function setBtnLoading(btn, loading){
    if (!btn) return;
    if (loading){
      if (!btn.dataset.orig) btn.dataset.orig = btn.innerHTML;
      btn.innerHTML = `<span class="spin" aria-hidden="true"></span>`;
      btn.disabled = true;
    } else {
      if (btn.dataset.orig) btn.innerHTML = btn.dataset.orig;
      btn.disabled = false;
    }
  }

  function normalizeHeader(h){
    return normalizeText(h).replace(/[\s\-_]+/g, "");
  }

  function truthyCell(v){
    const t = normalizeText(v);
    return t === "si" || t === "s√≠" || t === "s" || t === "1" || t === "true" || t === "x" || t === "yes";
  }

  function parseSizeCell(v){
    const t = normalizeText(v);
    if (!t) return "";

    // Espa√±ol claro
    if (t.includes("1/4") || t.includes("cuarto") || t.includes("1-4")) return "quarter";
    if (t.includes("media") || t.includes("mitad") || t.includes("horizontal")) return "half_h";
    if (t.includes("carta") || t.includes("completa") || t.includes("pagina completa") || t.includes("p√°gina completa")) return "full";

    // Ingl√©s / interno
    if (t.includes("quarter")) return "quarter";
    if (t.includes("half_h") || (t.includes("half") && !t.includes("quarter"))) return "half_h";
    if (t.includes("full")) return "full";

    if (t === "quarter" || t === "half_h" || t === "full") return t;
    return "";
  }

  // ‚úÖ Acepta plantilla base sin extensi√≥n
  const TEMPLATE_ALIASES = {
    "promocion": "promocion1.svg",
    "promoci√≥n": "promocion1.svg",
    "normal": "normal1.svg",
    "liquidacion": "liquidacion1.svg",
    "liquidaci√≥n": "liquidacion1.svg",
    "oferta": "oferta1.svg",

    // base exacta sin ext (lo que ver√° el personal)
    "promocion1": "promocion1.SVG",
    "normal1": "normal1.SVG",
    "liquidacion1": "liquidacion1.svg",
    "liquidaci√≥n1": "liquidacion1.svg",
    "oferta1": "oferta1.svg",
  };

  function parseTemplateCell(v){
    const raw = (v ?? "").toString().trim();
    if (!raw) return "";

    const allowed = getAllowedTemplates();
    const rawNorm = normalizeText(raw);

    // 1) Alias (incluye base sin extensi√≥n)
    if (TEMPLATE_ALIASES[rawNorm]) return TEMPLATE_ALIASES[rawNorm];

    // 2) Match exacto (con o sin extensi√≥n)
    const foundExact = allowed.find(a => normalizeText(a) === rawNorm);
    if (foundExact) return foundExact;

    // 3) Match por base (sin extensi√≥n)
    const rawBase = normalizeTemplateBase(raw);
    const foundByBase = allowed.find(a => normalizeTemplateBase(a) === rawBase);
    if (foundByBase) return foundByBase;

    // 4) Si alguien escribi√≥ "normal1svg" o parecido: intentar limpiar
    const maybe = rawNorm.replace(/[^a-z0-9]/g,"");
    const foundByLoose = allowed.find(a => normalizeTemplateBase(a).replace(/[^a-z0-9]/g,"") === maybe);
    return foundByLoose || "";
  }

  function parseNumberCell(v){
    if (v === null || v === undefined) return "";
    const s = (typeof v === "number") ? String(Math.trunc(v)) : String(v);
    return sanitizeIntStr(s.replace(/[^\d]/g, ""));
  }

  function pad2num(n){ return String(n).padStart(2,"0"); }
  function toISODateFromDate(d){
    const y = d.getFullYear();
    const m = pad2num(d.getMonth()+1);
    const day = pad2num(d.getDate());
    return `${y}-${m}-${day}`;
  }

  // ‚úÖ Ahora soporta DD/MM/AAAA (lo que pide el Excel)
  function parseDateCell(v){
    if (!v) return "";

    if (v instanceof Date && !isNaN(v.getTime())) return toISODateFromDate(v);

    // Excel serial date
    if (typeof v === "number" && Number.isFinite(v)){
      const ms = Math.round((v - 25569) * 86400 * 1000);
      const d = new Date(ms);
      if (!isNaN(d.getTime())) return toISODateFromDate(d);
      return "";
    }

    const s = String(v).trim();
    if (!s) return "";

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    // DD/MM/YYYY
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m){
      const dd = pad2num(parseInt(m[1],10));
      const mm = pad2num(parseInt(m[2],10));
      const yy = m[3];
      return `${yy}-${mm}-${dd}`;
    }

    return "";
  }

  function buildHeaderMap(headers){
    const map = {};
    headers.forEach((h, idx)=>{
      map[normalizeHeader(h)] = idx;
    });
    return map;
  }

  function cellBy(map, rowArr, keys){
    for (const k of keys){
      const idx = map[k];
      if (idx === 0 || idx) return rowArr[idx];
    }
    return "";
  }

  function parseExcelRowsToProducts(rows){
    if (!rows || rows.length < 2) return { products: [], errors: ["El archivo no tiene datos (m√≠nimo encabezados + 1 fila)."] };

    const headerRow = rows[0].map(h => (h ?? "").toString().trim());
    const map = buildHeaderMap(headerRow);

    const K = {
      template: ["plantilla","template","svg"],
      size: ["tamano","tama√±o","size"],
      nombre: ["nombre","producto","name"],
      antes: ["antes","precioantes","before"],
      ahora: ["ahora","precioahora","now"],
      cuota: ["cuota","cuotasemanal","weekly"],
      qty: ["cantidad","qty","cant"],
      useVig: ["agregarvigencia","vigencia","usevig"],
      vigStart: ["vigenciainicio","fechainicial","inicio","vigenciadesde"],
      vigEnd: ["vigenciafin","fechafinal","fin","vigenciahasta"]
    };

    const requiredCols = [
      ["Plantilla", K.template],
      ["Tama√±o", K.size],
      ["Nombre", K.nombre],
      ["Antes", K.antes],
      ["Ahora", K.ahora],
      ["Cuota", K.cuota],
      ["Cantidad", K.qty],
    ];

    const missing = requiredCols.filter(([_, keys]) => !keys.some(k => map[k] === 0 || map[k]));
    if (missing.length){
      return {
        products: [],
        errors: missing.map(([label]) => `Falta la columna requerida: "${label}".`)
      };
    }

    const allowedTemplates = getAllowedTemplates();
    const allowedBases = getAllowedTemplateBases();

    const errors = [];
    const out = [];

    for (let r = 1; r < rows.length; r++){
      const row = rows[r];
      if (!row || !row.length) continue;

      const hasAny = row.some(x => String(x ?? "").trim() !== "");
      if (!hasAny) continue;

      const rawTemplate = cellBy(map, row, K.template);
      const rawSize = cellBy(map, row, K.size);
      const rawNombre = cellBy(map, row, K.nombre);
      const rawAntes = cellBy(map, row, K.antes);
      const rawAhora = cellBy(map, row, K.ahora);
      const rawCuota = cellBy(map, row, K.cuota);
      const rawQty = cellBy(map, row, K.qty);
      const rawUseVig = cellBy(map, row, K.useVig);
      const rawVigStart = cellBy(map, row, K.vigStart);
      const rawVigEnd = cellBy(map, row, K.vigEnd);

      const p = emptyProduct();
      p.template = parseTemplateCell(rawTemplate);
      p.size = parseSizeCell(rawSize);
      p.nombre = (rawNombre ?? "").toString().trim();

      p.antes = parseNumberCell(rawAntes);
      p.ahora = parseNumberCell(rawAhora);
      p.cuota = parseNumberCell(rawCuota);

      const qtyN = parseInt(String(rawQty ?? "").replace(/[^\d]/g,""), 10);
      p.qty = Number.isFinite(qtyN) ? qtyN : 0;

      p.useVig = truthyCell(rawUseVig);
      p.vigStart = p.useVig ? parseDateCell(rawVigStart) : "";
      p.vigEnd = p.useVig ? parseDateCell(rawVigEnd) : "";

      const rowErrs = [];

      if (!p.template){
        rowErrs.push(`Plantilla inv√°lida. Usa solo el nombre (sin .svg). Permitidas: ${allowedBases.join(", ")}.`);
      }
      if (!p.size){
        rowErrs.push(`Tama√±o inv√°lido. Recomendado: 1/4, MEDIA HORIZONTAL, CARTA COMPLETA.`);
      }

      const baseErrs = validateProductData(p);
      baseErrs.forEach(e => rowErrs.push(e));

      if (rowErrs.length){
        errors.push(`Fila ${r+1}: ${rowErrs.join(" ")}`);
      } else {
        out.push(p);
      }
    }

    if (errors.length) return { products: [], errors };

    if (!out.length){
      return { products: [], errors: ["No hay filas v√°lidas para importar."] };
    }

    return { products: out, errors: [] };
  }

  async function readExcelFile(file){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });

    const sheetName = wb.SheetNames[0];
    if (!sheetName) throw new Error("El archivo no contiene hojas.");

    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
    return rows;
  }

  function askImportModeIfNeeded(onChoose){
    if (products.length === 0){
      onChoose("merge");
      return;
    }

    openModal({
      title: "Importaci√≥n masiva",
      bodyHtml: `
        <div class="modalText">
          Ya tienes <b>${products.length}</b> producto(s) guardado(s).<br>
          ¬øQu√© deseas hacer?
          <div style="margin-top:10px">
            <span class="pill">Mantener y agregar</span>
            <span class="pill">Reemplazar todo</span>
          </div>
        </div>
      `,
      actions: [
        { text:"Cancelar", className:"btnNeutral", onClick: ()=>{ closeModal(); } },
        { text:"Reemplazar todo", className:"btnNeutral", onClick: ()=>{ closeModal(); onChoose("replace"); } },
        { text:"Mantener y agregar", className:"btnSuccess", onClick: ()=>{ closeModal(); onChoose("merge"); } },
      ]
    });
  }

  function showImportErrors(errs){
    const list = `
      <ul class="errList">
        ${errs.slice(0, 80).map(e => `<li>${escapeHtml(e)}</li>`).join("")}
      </ul>
      ${errs.length > 80 ? `<div class="modalText" style="margin-top:10px;color:#64748b">Se muestran 80 errores. Corrige el Excel y vuelve a importar.</div>` : ""}
    `;

    openModal({
      title: "Importaci√≥n rechazada",
      bodyHtml: `
        <div class="modalText">
          El archivo tiene errores. No se cre√≥ ning√∫n producto.
          <div style="margin-top:10px" class="pill">Corrige y reintenta</div>
        </div>
        ${list}
      `,
      actions: [
        { text:"Cerrar", className:"btnNeutral", onClick: ()=> closeModal() }
      ]
    });
  }

  function showImportSuccess(count){
    openModal({
      title: "Importaci√≥n completada",
      bodyHtml: `
        <div class="modalText">
          Se importaron <b>${count}</b> producto(s) correctamente.
        </div>
      `,
      actions: [
        { text:"OK", className:"btnSuccess", onClick: ()=> closeModal() }
      ]
    });
  }

  async function handleImportFile(file){
    if (!file) return;

    importing = true;
    setBtnLoading($("btnImport"), true);

    try{
      const rows = await readExcelFile(file);
      const parsed = parseExcelRowsToProducts(rows);

      if (parsed.errors && parsed.errors.length){
        showImportErrors(parsed.errors);
        return;
      }

      const imported = parsed.products;

      askImportModeIfNeeded((mode)=>{
        const nowText = formatDateTimeNow();

        let base = (mode === "replace") ? [] : [...products];

        const newOnes = imported.map(p => {
          const pp = { ...p };
          pp.id = uid();
          pp.impresionAt = nowText;
          pp.colorIdx = allocateColorIdx(base);
          base.push(pp);
          return pp;
        });

        if (mode === "replace"){
          products = newOnes;
          renderCache.clear();
          templateTextCache.clear();
          previewSlotsByProduct.clear();
          expandedId = null;
          selectedProductId = null;
        } else {
          products = [...products, ...newOnes];
        }

        const firstId = newOnes[0]?.id || null;
        if (firstId){
          selectedProductId = firstId;
          expandedId = firstId;
        }

        updateTopButtonsVisibility();
        renderItemsList();
        schedulePreviewRebuild();
        requestAnimationFrame(()=> applySelectionHighlight());
        requestSaveState();

        showImportSuccess(newOnes.length);
      });

    } catch (e){
      console.error(e);
      openModal({
        title: "Error al importar",
        bodyHtml: `<div class="modalText">No se pudo leer el archivo. Aseg√∫rate que sea Excel (.xlsx/.xls) y que tenga encabezados correctos.</div>`,
        actions: [{ text:"Cerrar", className:"btnNeutral", onClick: ()=> closeModal() }]
      });
    } finally {
      importing = false;
      setBtnLoading($("btnImport"), false);
      $("fileImport").value = "";
    }
  }

  $("btnImport").addEventListener("click", ()=>{
    if (!isListView()) return;
    if (importing) return;
    $("fileImport").click();
  });

  $("fileImport").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    await handleImportFile(file);
  });

  $("btnTemplate").addEventListener("click", ()=>{
    if (!isListView()) return;
    downloadExcelTemplate();
  });

  /* ===== SVG helpers (render) ===== */
  async function loadTemplateText(file){
    if (templateTextCache.has(file)) return templateTextCache.get(file);
    const res = await fetch(file, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo cargar " + file + ". Debe estar junto al HTML.");
    const txt = await res.text();
    templateTextCache.set(file, txt);
    return txt;
  }

  function getSvgViewBox(svg) {
    const vb = svg.viewBox && svg.viewBox.baseVal;
    if (vb && vb.width && vb.height) return { x: vb.x, y: vb.y, w: vb.width, h: vb.height };
    const w = parseFloat(svg.getAttribute("width") || "0") || 0;
    const h = parseFloat(svg.getAttribute("height") || "0") || 0;
    return { x: 0, y: 0, w: w || 1000, h: h || 1000 };
  }

  function clearSvgText(el){
    if (!el) return;
    while (el.firstChild) el.removeChild(el.firstChild);
    el.textContent = "";
  }
  function setSvgText(el, txt){
    if (!el) return;
    const t = (txt ?? "").toString();
    if (!t.trim()){ clearSvgText(el); return; }
    const tspan = el.querySelector ? el.querySelector("tspan") : null;
    if (tspan) tspan.textContent = t;
    else el.textContent = t;
  }
  function findByAnyId(svg, ids){
    for (const id of ids){
      const el = svg.querySelector(`#${cssEsc(id)}`);
      if (el) return el;
    }
    return null;
  }
  function replaceTokenInSvg(svg, token, value){
    if (!svg || !token) return;
    svg.querySelectorAll("tspan").forEach(ts => {
      if (ts.textContent && ts.textContent.includes(token)){
        ts.textContent = ts.textContent.split(token).join(value);
      }
    });
    svg.querySelectorAll("text").forEach(t => {
      if (t.querySelector("tspan")) return;
      if (t.textContent && t.textContent.includes(token)){
        t.textContent = t.textContent.split(token).join(value);
      }
    });
  }

  function getFontSizePx(textEl) {
    const fsAttr = textEl.getAttribute("font-size");
    if (fsAttr) {
      const n = parseFloat(fsAttr);
      if (Number.isFinite(n)) return n;
    }
    const cs = window.getComputedStyle(textEl);
    const n = parseFloat(cs.fontSize || "0");
    return Number.isFinite(n) && n > 0 ? n : 16;
  }

  function getTextBoxById(svg, textId) {
    const box = svg.querySelector(`#box_${cssEsc(textId)}`);
    if (box && typeof box.getBBox === "function") {
      const b = box.getBBox();
      return { x: b.x, y: b.y, w: b.width, h: b.height, cx: b.x + b.width/2, cy: b.y + b.height/2 };
    }
    const vb = getSvgViewBox(svg);
    const w = vb.w * 0.85;
    const h = vb.h * 0.18;
    return { x: vb.x + (vb.w - w)/2, y: vb.y + vb.h*0.18, w, h, cx: vb.x + vb.w/2, cy: vb.y + vb.h*0.27 };
  }

  function setWrappedTextInBox(textEl, text, box, opts = {}) {
    const NS = "http://www.w3.org/2000/svg";
    const t = (text || "").trim();
    if (!t) { clearSvgText(textEl); return; }

    const words = t.split(/\s+/).filter(Boolean);
    const lineHeightEm = opts.lineHeightEm ?? 1.10;
    const maxWidth = box.w;

    const fontPx = getFontSizePx(textEl);
    const maxLines = Math.max(1, Math.floor(box.h / (fontPx * lineHeightEm)));

    const cx = box.cx;
    const cy = box.cy;

    textEl.setAttribute("text-anchor", "middle");
    textEl.setAttribute("x", cx);
    textEl.setAttribute("y", cy);

    while (textEl.firstChild) textEl.removeChild(textEl.firstChild);

    const meas = document.createElementNS(NS, "tspan");
    meas.setAttribute("x", cx);
    textEl.appendChild(meas);

    let lines = [];
    let line = [];

    for (let i = 0; i < words.length; i++) {
      line.push(words[i]);
      meas.textContent = line.join(" ");
      if (meas.getComputedTextLength() > maxWidth && line.length > 1) {
        line.pop();
        lines.push(line.join(" "));
        line = [words[i]];
        if (lines.length === maxLines) break;
        meas.textContent = line.join(" ");
      }
    }
    if (lines.length < maxLines && line.length) lines.push(line.join(" "));

    if (words.length && lines.length === maxLines) {
      let last = lines[lines.length - 1];
      meas.textContent = last;
      while (meas.getComputedTextLength() > maxWidth && last.length > 1) {
        last = last.slice(0, -2) + "‚Ä¶";
        meas.textContent = last;
      }
      lines[lines.length - 1] = last;
    }

    while (textEl.firstChild) textEl.removeChild(textEl.firstChild);

    const n = Math.max(lines.length, 1);
    const totalEm = (n - 1) * lineHeightEm;
    const firstDy = -totalEm / 2;

    lines.forEach((txt, idx) => {
      const ts = document.createElementNS(NS, "tspan");
      ts.setAttribute("x", cx);
      ts.setAttribute("dy", (idx === 0 ? firstDy : lineHeightEm) + "em");
      ts.textContent = txt;
      textEl.appendChild(ts);
    });
  }

  async function svgNodeToPng(svgNode, targetWidthPx = 2200){
    const serializer = new XMLSerializer();
    let svgText = serializer.serializeToString(svgNode);

    if (!svgText.includes('xmlns="http://www.w3.org/2000/svg"')) {
      svgText = svgText.replace("<svg", '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if (!svgText.includes('xmlns:xlink="http://www.w3.org/1999/xlink"')) {
      svgText = svgText.replace("<svg", '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    const vb = getSvgViewBox(svgNode);
    const w = vb.w || parseFloat(svgNode.getAttribute("width") || "408");
    const h = vb.h || parseFloat(svgNode.getAttribute("height") || "528");

    const scale = targetWidthPx / w;
    const cw = Math.round(w * scale);
    const ch = Math.round(h * scale);

    const blob = new Blob([svgText], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.crossOrigin = "anonymous";

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = url;
    });

    const canvas = $("workCanvas");
    canvas.width = cw;
    canvas.height = ch;

    const ctx = canvas.getContext("2d");
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, cw, ch);
    ctx.drawImage(img, 0, 0, cw, ch);

    URL.revokeObjectURL(url);
    return canvas.toDataURL("image/png");
  }

  async function rotatePng90(pngDataUrl){
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = pngDataUrl;
    });

    const canvas = $("workCanvas");
    canvas.width = img.height;
    canvas.height = img.width;

    const ctx = canvas.getContext("2d");
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.translate(canvas.width, 0);
    ctx.rotate(Math.PI / 2);
    ctx.drawImage(img, 0, 0);

    return canvas.toDataURL("image/png");
  }

  function renderKey(p){
    return JSON.stringify({
      template: p.template,
      nombre: (p.nombre || "").trim().toUpperCase(),
      antes: p.antes, ahora: p.ahora, cuota: p.cuota,
      useVig: !!p.useVig, vigStart: p.vigStart || "", vigEnd: p.vigEnd || "",
      impresionAt: (p.impresionAt || "").trim(),
    });
  }

  async function renderProductToPngs(p){
    const key = renderKey(p);
    if (renderCache.has(key)) return renderCache.get(key);

    const svgText = await loadTemplateText(p.template);
    const host = $("__svgHostHidden");
    host.innerHTML = svgText;

    const svg = host.querySelector("svg");
    if (!svg) throw new Error("El archivo no contiene un <svg> v√°lido: " + p.template);

    const upperName = (p.nombre || "").trim().toUpperCase();
    const antes = toQuetzales(p.antes);
    const ahora = toQuetzales(p.ahora);
    const cuota = toQuetzales(p.cuota);

    const nameEl = svg.querySelector("#" + cssEsc(SVG_IDS.nombre));
    if (nameEl){
      const box = getTextBoxById(svg, SVG_IDS.nombre);
      setWrappedTextInBox(nameEl, upperName, box, { lineHeightEm: 1.10 });
    }

    setSvgText(svg.querySelector("#" + cssEsc(SVG_IDS.antes)), antes);
    setSvgText(svg.querySelector("#" + cssEsc(SVG_IDS.ahora)), ahora);
    setSvgText(svg.querySelector("#" + cssEsc(SVG_IDS.cuota)), cuota);

    const vigEl = svg.querySelector("#" + cssEsc(SVG_IDS.vigencia));
    if (p.useVig && p.vigStart && p.vigEnd){
      const txt = `* V√ÅLIDO DESDE ${formatDMY(p.vigStart)} AL ${formatDMY(p.vigEnd)}`;
      setSvgText(vigEl, txt);
      replaceTokenInSvg(svg, "[Fecha_vigencia]", txt);
    } else {
      clearSvgText(vigEl);
      replaceTokenInSvg(svg, "[Fecha_vigencia]", "");
    }

    // ‚úÖ Fecha impresi√≥n SIEMPRE real
    const impTxt = (p.impresionAt && p.impresionAt.trim()) ? p.impresionAt.trim() : formatDateTimeNow();
    const impEl = findByAnyId(svg, SVG_IDS.impresionCandidates);
    setSvgText(impEl, impTxt);
    replaceTokenInSvg(svg, "[Fecha_impresion]", impTxt);
    replaceTokenInSvg(svg, "[fecha_impresion]", impTxt);
    replaceTokenInSvg(svg, "[FECHA_IMPRESION]", impTxt);

    const pngNormal = await svgNodeToPng(svg, 2200);
    const pngRotated = await rotatePng90(pngNormal);

    const out = { pngNormal, pngRotated };
    renderCache.set(key, out);
    return out;
  }

  /* ===== Packing ===== */
  function makeGridPage(){ return { type: "grid", occ: [[null,null],[null,null]], placements: [] }; }
  function rowEmpty(page, r){ return !page.occ[r][0] && !page.occ[r][1]; }

  function placeQuarter(page, item){
    const prefer = [];
    const any = [];

    for (let r=0; r<2; r++){
      const emptyCols = [];
      for (let c=0; c<2; c++) if (!page.occ[r][c]) emptyCols.push(c);
      if (!emptyCols.length) continue;

      const filled = 2 - emptyCols.length;
      if (filled === 1 && emptyCols.length === 1) prefer.push({r, c: emptyCols[0]});
      else any.push({r, c: emptyCols[0]});
    }
    const spot = prefer[0] || any[0];
    if (!spot) return false;

    page.occ[spot.r][spot.c] = item;
    page.placements.push({ item, row: spot.r+1, col: spot.c+1, rs: 1, cs: 1 });
    return true;
  }

  function placeHalf(page, item){
    const opts = [];
    for (let r=0; r<2; r++){
      if (rowEmpty(page, r)){
        const other = r === 0 ? 1 : 0;
        const otherHas = (!!page.occ[other][0] || !!page.occ[other][1]);
        opts.push({r, score: otherHas ? 2 : 1});
      }
    }
    if (!opts.length) return false;
    opts.sort((a,b)=> b.score - a.score);

    const r = opts[0].r;
    page.occ[r][0] = item;
    page.occ[r][1] = item;
    page.placements.push({ item, row: r+1, col: 1, rs: 1, cs: 2 });
    return true;
  }

  function packAll(items){
    const pages = [];

    for (const it of items){
      const size = it.product.size;

      if (size === "full"){
        pages.push({ type: "full", placements: [{ item: it, row: 1, col: 1, rs: 1, cs: 1 }] });
        continue;
      }

      let placed = false;

      for (const page of pages){
        if (page.type !== "grid") continue;
        if (size === "quarter") placed = placeQuarter(page, it);
        else if (size === "half_h") placed = placeHalf(page, it);
        if (placed) break;
      }

      if (!placed){
        const p = makeGridPage();
        pages.push(p);
        if (size === "quarter") placeQuarter(p, it);
        else placeHalf(p, it);
      }
    }

    return pages;
  }

  function buildItemsForPacking(includeDraft){
    const list = [];

    const d = includeDraft ? (() => {
      syncDraftFromForm();

      if (editingId) {
        return {
          ...draft,
          id: editingId,
          impresionAt: draft.impresionAt || formatDateTimeNow(),
          qty: (Number.isFinite(draft.qty) && draft.qty > 0) ? draft.qty : (draft.qty === 0 ? 0 : 1),
          colorIdx: Number.isFinite(draft.colorIdx) ? draft.colorIdx : (products.find(p => p.id === editingId)?.colorIdx ?? 0),
        };
      }

      if (draft.template && draft.size) {
        return {
          ...draft,
          id: "__draft__",
          impresionAt: draft.impresionAt || formatDateTimeNow(),
          qty: (Number.isFinite(draft.qty) && draft.qty > 0) ? draft.qty : 1,
          colorIdx: Number.isFinite(draft.colorIdx) ? draft.colorIdx : 0,
        };
      }
      return null;
    })() : null;

    for (const p of products){
      const source = (includeDraft && editingId && p.id === editingId) ? d : p;
      if (!source) continue;

      for (let i=0; i<(source.qty || 0); i++){
        list.push({ product: source, isDraft: false, instanceIndex: i });
      }
    }

    if (includeDraft && !editingId && d && d.id === "__draft__"){
      for (let i=0; i<(d.qty || 1); i++){
        list.push({ product: d, isDraft: true, instanceIndex: i });
      }
    }

    if (includeDraft && editingId && d){
      for (const it of list){
        if (it.product.id === editingId) it.isDraft = true;
      }
    }

    return list;
  }

  /* ===== Preview ===== */
  async function buildPreview(){
    const includeDraft = !isListView();
    const items = buildItemsForPacking(includeDraft);

    if (items.length === 0){
      showEmptyPreview("Sin previsualizaci√≥n", "Agrega productos para ver c√≥mo se acomodan en las hojas.");
      previewSlotsByProduct.clear();
      return;
    }

    for (const it of items){
      if (!it.product.template || !it.product.size) continue;
      const r = await renderProductToPngs(it.product);
      it._png = (it.product.size === "half_h") ? r.pngRotated : r.pngNormal;
    }

    const pages = packAll(items);
    const preview = $("paperPreview");
    preview.innerHTML = "";

    previewSlotsByProduct = new Map();

    pages.forEach((page, pageIndex) => {
      const shell = document.createElement("div");
      shell.className = "page-shell";
      shell.style.setProperty("--previewScale", PREVIEW_SCALE);

      const pageLabel = document.createElement("div");
      pageLabel.className = "pageLabel";
      pageLabel.textContent = `HOJA ${pageIndex+1}`;
      shell.appendChild(pageLabel);

      const inner = document.createElement("div");
      inner.className = "page-inner";

      const paper = document.createElement("div");
      paper.className = "paper-page " + (page.type === "full" ? "paper-full" : "paper-grid");

      for (const pl of page.placements){
        const it = pl.item;
        if (!it._png) continue;

        const slot = document.createElement("div");
        slot.className = "slot" + (it.isDraft ? " draft" : "");
        slot.style.gridRow = `${pl.row} / span ${pl.rs}`;
        slot.style.gridColumn = `${pl.col} / span ${pl.cs}`;
        slot.dataset.productId = it.product.id || "";

        const pid = it.product.id || "";

        if (pid && pid !== "__draft__"){
          const c = pairColor(pid);
          const gs = pairGlow(pid, true);
          slot.style.setProperty("--pairColor", c);
          slot.style.setProperty("--pairGlowStrong", gs);

          const mark = document.createElement("div");
          mark.className = "pairMark";
          slot.appendChild(mark);

          if (!previewSlotsByProduct.has(pid)) previewSlotsByProduct.set(pid, []);
          previewSlotsByProduct.get(pid).push(slot);
        }

        const img = document.createElement("img");
        img.src = it._png;
        img.alt = "Etiqueta";
        slot.appendChild(img);

        if (it.isDraft){
          const tag = document.createElement("div");
          tag.className = "draftTag";
          tag.textContent = (formMode === "edit") ? "EDITANDO" : "AGREGANDO";
          slot.appendChild(tag);
        }

        paper.appendChild(slot);
      }

      inner.appendChild(paper);
      shell.appendChild(inner);
      preview.appendChild(shell);
    });

    if (pendingFocus && pendingFocus.id){
      const { id, scroll } = pendingFocus;
      pendingFocus = null;

      if (id === "__draft__"){
        ensureDraftVisible();
      } else {
        highlightProductInPreview(id, !!scroll, false);
      }
    }

    if (includeDraft){
      ensureDraftVisible();
    } else {
      applySelectionHighlight();
    }
  }

  function schedulePreviewRebuild(){
    clearTimeout(previewTimer);
    previewTimer = setTimeout(() => buildPreview().catch(console.error), 160);
  }

  /* ============================
     Impresi√≥n (multi p√°ginas ok)
  ============================ */
  async function waitForImages(container){
    const imgs = Array.from(container.querySelectorAll("img"));
    if (!imgs.length) return;

    await Promise.all(imgs.map(img => {
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise((resolve) => {
        img.onload = () => resolve();
        img.onerror = () => resolve();
      });
    }));

    await Promise.all(imgs.map(img => {
      if (img.decode) return img.decode().catch(()=>{});
      return Promise.resolve();
    }));
  }

  async function nextFrame(){
    await new Promise(requestAnimationFrame);
    await new Promise(requestAnimationFrame);
  }

  async function printNow(){
    if (products.length === 0) return;

    const items = buildItemsForPacking(false);
    for (const it of items){
      const r = await renderProductToPngs(it.product);
      it._png = (it.product.size === "half_h") ? r.pngRotated : r.pngNormal;
    }

    const pages = packAll(items);

    const root = $("printRoot");
    root.innerHTML = "";
    root.style.display = "block";

    for (const page of pages){
      const wrap = document.createElement("div");
      wrap.className = "print-page";

      const paper = document.createElement("div");
      paper.className = "paper-page " + (page.type === "full" ? "paper-full" : "paper-grid");

      for (const pl of page.placements){
        const it = pl.item;
        if (!it._png) continue;

        const slot = document.createElement("div");
        slot.className = "slot";
        slot.style.gridRow = `${pl.row} / span ${pl.rs}`;
        slot.style.gridColumn = `${pl.col} / span ${pl.cs}`;

        const img = document.createElement("img");
        img.src = it._png;
        img.alt = "Etiqueta";
        slot.appendChild(img);

        paper.appendChild(slot);
      }

      wrap.appendChild(paper);
      root.appendChild(wrap);
    }

    await waitForImages(root);
    await nextFrame();

    const cleanup = () => {
      root.style.display = "none";
      root.innerHTML = "";
      window.removeEventListener("afterprint", cleanup);
    };
    window.addEventListener("afterprint", cleanup);

    window.print();
  }

  /* ===== Export PDF ===== */
  async function getImgDim(dataUrl){
    if (imgDimCache.has(dataUrl)) return imgDimCache.get(dataUrl);

    const p = new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve({ w: img.naturalWidth || img.width, h: img.naturalHeight || img.height });
      img.onerror = reject;
      img.src = dataUrl;
    });

    imgDimCache.set(dataUrl, p);
    return p;
  }

  function boxForPlacement(pageType, row, col, rs, cs){
    const pageW = 215.9, pageH = 279.4;
    const padGrid = 6, gapGrid = 6;
    const padFull = 10;

    if (pageType === "full"){
      const pad = padFull;
      const availW = pageW - (pad*2);
      const availH = pageH - (pad*2);
      return { x: pad, y: pad, w: availW, h: availH };
    }

    const pad = padGrid;
    const gap = gapGrid;
    const availW = pageW - (pad*2);
    const availH = pageH - (pad*2);

    const cols = 2, rows = 2;
    const cellW = (availW - gap) / cols;
    const cellH = (availH - gap) / rows;

    const x = pad + (col-1) * (cellW + gap);
    const y = pad + (row-1) * (cellH + gap);

    const w = cellW * cs + gap * (cs-1);
    const h = cellH * rs + gap * (rs-1);

    return { x, y, w, h };
  }

  function setIconLoading(btn, loading){
    if (!btn) return;
    if (loading){
      if (!btn.dataset.orig) btn.dataset.orig = btn.innerHTML;
      btn.innerHTML = `<span class="spin" aria-hidden="true"></span>`;
      btn.disabled = true;
    } else {
      if (btn.dataset.orig) btn.innerHTML = btn.dataset.orig;
      btn.disabled = false;
    }
  }

  async function exportPdf(){
    if (products.length === 0) return;

    if (!window.jspdf || !window.jspdf.jsPDF){
      alert("No se pudo cargar jsPDF. Revisa tu conexi√≥n o el script CDN.");
      return;
    }
    const { jsPDF } = window.jspdf;

    const items = buildItemsForPacking(false);
    for (const it of items){
      const r = await renderProductToPngs(it.product);
      it._png = (it.product.size === "half_h") ? r.pngRotated : r.pngNormal;
    }
    const pages = packAll(items);

    const doc = new jsPDF({ orientation:"portrait", unit:"mm", format:"letter" });

    for (let pi=0; pi<pages.length; pi++){
      if (pi > 0) doc.addPage("letter", "portrait");

      const page = pages[pi];
      const pageType = page.type === "full" ? "full" : "grid";

      for (const pl of page.placements){
        const it = pl.item;
        if (!it._png) continue;

        const box = boxForPlacement(pageType, pl.row, pl.col, pl.rs, pl.cs);
        const dim = await getImgDim(it._png);

        const scale = Math.min(box.w / dim.w, box.h / dim.h);
        const drawW = dim.w * scale;
        const drawH = dim.h * scale;

        const dx = box.x + (box.w - drawW) / 2;
        const dy = box.y + (box.h - drawH) / 2;

        doc.addImage(it._png, "PNG", dx, dy, drawW, drawH);
      }
    }

    doc.save("etiquetas.pdf");
  }

  async function exportPdfWithLoading(){
    if (exporting) return;
    exporting = true;

    const btn = $("btnPdf");
    setIconLoading(btn, true);

    try{
      await new Promise(r => setTimeout(r, 60));
      await exportPdf();
    } catch (e){
      console.error(e);
      alert("No se pudo exportar a PDF. Revisa la consola para m√°s detalle.");
    } finally{
      setIconLoading(btn, false);
      exporting = false;
    }
  }

  /* ===== Eventos ===== */
  $("btnShowForm").addEventListener("click", openAddForm);
  $("btnCancel").addEventListener("click", backToList);
  $("btnSave").addEventListener("click", saveDraft);
  $("btnResetAll").addEventListener("click", resetAll);
  $("btnPrint").addEventListener("click", printNow);
  $("btnPdf").addEventListener("click", exportPdfWithLoading);

  ["fAntes","fAhora","fCuota"].forEach(id => {
    const el = $(id);

    el.addEventListener("keydown", (e)=>{
      const allowed = ["Backspace","Delete","ArrowLeft","ArrowRight","Home","End","Tab"];
      if (allowed.includes(e.key)) return;
      if (e.ctrlKey || e.metaKey) return;
      if (!/^\d$/.test(e.key)) e.preventDefault();
    });

    el.addEventListener("input", ()=>{
      el.value = sanitizeIntStr(el.value);
      validateDraft();
      schedulePreviewRebuild();
    });

    el.addEventListener("paste", ()=>{
      setTimeout(()=>{
        el.value = sanitizeIntStr(el.value);
        validateDraft();
        schedulePreviewRebuild();
      }, 0);
    });
  });

  ["fTemplate","fSize","fNombre","fQty","fUseVig","fVigStart","fVigEnd"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ validateDraft(); schedulePreviewRebuild(); });
    $(id).addEventListener("change", ()=>{ validateDraft(); schedulePreviewRebuild(); });
  });

  $("fUseVig").addEventListener("change", ()=>{
    $("vigDates").style.display = $("fUseVig").checked ? "block" : "none";
    validateDraft();
    schedulePreviewRebuild();
  });

  /* ===== Init ===== */
  (function init(){
    const restored = loadState();

    if (!restored){
      setView("list");
      showEmptyPreview("Sin previsualizaci√≥n", "Agrega productos o importa un Excel para ver c√≥mo se acomodan.");
    }

    let changed = false;
    for (const p of products){
      if (!Number.isFinite(p.colorIdx)){
        p.colorIdx = allocateColorIdx();
        changed = true;
      }
      if (!p.impresionAt) p.impresionAt = formatDateTimeNow();
    }
    if (changed) requestSaveState();

    updateTopButtonsVisibility();
    renderItemsList();
    schedulePreviewRebuild();
    requestSaveState();
  })();
</script>
</body>
</html>
